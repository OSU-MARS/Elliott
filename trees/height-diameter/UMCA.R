# load libraries, functions, and trees2016 from Elliott Stand Data Feb2022.R

## Oregon myrtle (California bay) height-diameter regression form sweep
umca2016 = trees2016 %>% filter(Species == "OM", isLiveUnbroken, is.na(TotalHt) == FALSE) %>% # live Oregon myrtles measured for height
  mutate(dbhWeight = pmin(TreeCount/(1.09*DBH^0.83), 5*TreeCount),
         heightWeight = pmin(TreeCount/(2.10*(TotalHt - 1.37)^1.83), 5*TreeCount))
umca2016physio = umca2016 %>% filter(is.na(elevation) == FALSE)
umca2016gamConstraint = c(DBH = -0.8547/0.8790, TotalHt = 1.37, standBasalAreaPerHectare = median(umca2016$standBasalAreaPerHectare), basalAreaLarger = median(umca2016$basalAreaLarger), standBasalAreaApprox = median(umca2016$standBasalAreaApprox), tallerApproxBasalArea = median(umca2016$tallerApproxBasalArea), elevation = median(umca2016physio$elevation), slope = median(umca2016physio$slope), aspect = median(umca2016physio$aspect), topographicShelterIndex = median(umca2016physio$topographicShelterIndex), relativeHeight = median(umca2016$relativeHeight), relativeDiameter = median(umca2016$relativeDiameter)) # point constraint for mgcv::s()

umca2016defaultWeight = umca2016 %>% mutate(dbhWeight = pmin(TreeCount/DBH, 5*TreeCount),
                                            heightWeight = pmin(TreeCount/TotalHt, 5*TreeCount))
umca2016defaultWeightPhysio = umca2016defaultWeight %>% filter(is.na(elevation) == FALSE)

umcaOptions = tibble(fitHeight = FALSE, 
                     fitHeightNlrob = fitHeight,
                     fitHeightGnls = FALSE,
                     fitHeightMixed = fitHeight,
                     fitDbh = FALSE,
                     fitDbhNlrob = fitDbh,
                     fitDbhMixed = fitDbh)

if (umcaOptions$fitHeight)
{
  umcaHeightFromDiameter = list(linear = fit_lm("linear", TotalHt ~ 0 + DBH + I(isPlantation*DBH), umca2016))
  umcaHeightFromDiameter$parabolic = fit_lm("parabolic", TotalHt ~ 0 + DBH + I(DBH^2) + I(isPlantation*DBH) + I(isPlantation*DBH^2), umca2016)
  
  umcaHeightFromDiameter$chapmanRichards = fit_gsl_nls("Chapman-Richards", TotalHt ~ 1.37 + a1 * (1 - exp(b1*DBH))^b2, umca2016, start = list(a1 = 18, b1 = -0.05, b2 = 1.06)) # a1p, b1p, b2p not significant
  umcaHeightFromDiameter$chapmanRichardsBal = fit_gsl_nls("Chapman-Richards BA+L", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger) * (1 - exp(b1*DBH))^b2, umca2016, start = list(a1 = 18, a2 = 0.23, b1 = -0.04, b2 = 1.0), significant = FALSE) # a2, a2p, a3, a3p, b1p, b2p not significant
  umcaHeightFromDiameter$chapmanRichardsBalPhysio = fit_gsl_nls("Chapman-Richards BA+L physio", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger + a4 * elevation) * (1 - exp(b1*DBH))^b2, umca2016physio, start = list(a1 = 20, a2 = 0.03, a4 = -0.012, b1 = -0.05, b2 = 1.06), significant = FALSE) # a1p, a2, a2p, a3, a4, a5, a6, a7, a8, b1p, b2p not significant
  umcaHeightFromDiameter$chapmanRichardsBalPhysioRelDbh = fit_gsl_nls("Chapman-Richards BA+L RelDbh physio", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger + a4 * elevation + a10 * relativeDiameter) * (1 - exp(b1*DBH))^b2, umca2016physio, start = list(a1 = 20, a2 = 0, a4 = -0.01, a10 = 0, b1 = -0.05, b2 = 1.04), significant = FALSE) # a10, a10p not significant
  umcaHeightFromDiameter$chapmanRichardsBalRelDbh = fit_gsl_nls("Chapman-Richards BA+L RelDbh", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger + a10 * relativeDiameter) * (1 - exp(b1*DBH))^b2, umca2016, start = list(a1 = 18, a2 = 0, a10 = 0, b1 = -0.05, b2 = 1.02), significant = FALSE) # a10, a10p not significant
  umcaHeightFromDiameter$chapmanRichardsBalRelHt = fit_gsl_nls("Chapman-Richards BA+L RelHt", TotalHt ~ 1.37 + (a1 + a3 * standBasalAreaPerHectare + (a9 + a9p * isPlantation) * relativeHeight) * (1 - exp(b1*DBH))^b2, umca2016, start = list(a1 = -1.7, a3 = 0.05, a9 = 50, a9p = -16, b1 = -0.08, b2 = 0.48)) # a1p, a2, a2p, a3p, b1p, b2p not significant
  umcaHeightFromDiameter$chapmanRichardsPhysio = fit_gsl_nls("Chapman-Richards physio", TotalHt ~ 1.37 + (a1 + a4 * elevation) * (1 - exp(b1*DBH))^b2, umca2016physio, start = list(a1 = 20, a4 = -0.014, b1 = -0.05, b2 = 1.1), significant = FALSE) # a4, a5, a6, a7, a8, b1p, b2p not significant
  umcaHeightFromDiameter$chapmanRichardsRelDbh = fit_gsl_nls("Chapman-Richards RelDbh", TotalHt ~ 1.37 + (a1 + a10 * relativeDiameter) * (1 - exp(b1*DBH))^b2, umca2016, start = list(a1 = 18, a10 = 0, b1 = -0.04, b2 = 1.04), significant = FALSE) # a10, a10p not significant
  umcaHeightFromDiameter$chapmanRichardsRelDbhPhysio = fit_gsl_nls("Chapman-Richards RelDbh physio", TotalHt ~ 1.37 + (a1 + a4 * elevation + a10 * relativeDiameter) * (1 - exp(b1*DBH))^b2, umca2016physio, start = list(a1 = 22, a4 = -0.012, a10 = 0, b1 = -0.05, b2 = 1.1), significant = FALSE) # a10, a10p not significant
  umcaHeightFromDiameter$curtis = fit_gsl_nls("Curtis", TotalHt ~ 1.37 + a1 * DBH / (1 + DBH)^b1, umca2016, start = list(a1 = 1.6, b1 = 0.4)) # a1p, b1p not significant
  umcaHeightFromDiameter$hossfeld = fit_gsl_nls("Hossfeld IV", TotalHt ~ 1.37 + (a1 + a1p * isPlantation) / (1 + (b1 + b1p * isPlantation) *DBH^b2), umca2016, start = list(a1 = 21.4, a1p = -4.37, b1 = 43.8, b1p = -19.9, b2 = -1.27)) # b2p not significant
  umcaHeightFromDiameter$korf = fit_gsl_nls("Korf", TotalHt ~ 1.37 + a1*exp((b1 + b1p * isPlantation)*DBH^b2), umca2016, start = list(a1 = 49.8, b1 = -5.02, b1p = 0.404, b2 = -0.386)) # a1p, b2p not significant
  umcaHeightFromDiameter$michaelisMenten = fit_gsl_nls("Michaelis-Menten", TotalHt ~ 1.37 + (a1 + a1p*isPlantation)*DBH^b1 / (a2 + a2p * isPlantation + DBH^b1), umca2016, start = list(a1 = 21.4, a1p = -4.37, a2 = 43.8, a2p = -20.0, b1 = 1.27)) # b1p not significant
  umcaHeightFromDiameter$prodan = fit_gsl_nls("Prodan", TotalHt ~ 1.37 + DBH^2 / ((a1 + a1p * isPlantation) * DBH^2 + (a2 + a2p * isPlantation)*DBH + a3), umca2016, start = list(a1 = 0.037, a1p = 0.020, a2 = 1.109, a2p = -0.472, a3 = 1.242)) # a3p not significant
  umcaHeightFromDiameter$power = fit_gsl_nls("power", TotalHt ~ 1.37 + (a1 + a1p * isPlantation)*DBH^b1, umca2016, start = list(a1 = 0.821, a1p = 0.206, b1 = 0.810)) # b1p not significant
  umcaHeightFromDiameter$ratkowsky = fit_gsl_nls("Ratkowsky", TotalHt ~ 1.37 + a1*exp((b1 + b1p * isPlantation)/(DBH + b2)), umca2016, start = list(a1 = 21.6, b1 = -16.5, b1p = 1.974, b2 = 3.629)) # a1p, b2p not significant
  umcaHeightFromDiameter$richardsW = fit_gsl_nls("unified Richards", TotalHt ~ 1.37 + (Ha + Hap * isPlantation) * (1 + ((1.37/(Ha + Hap * isPlantation))^(1 - d) - 1) * exp((-(kU + kUp * isPlantation) * DBH)/d^(d/(1 - d))))^(1/(1 - d)), umca2016, start = list(Ha = 14.6, Hap = -4.146, d = 2.198, kU = 0.048, kUp = 0.045)) # dp not significant, job step factor with nlrob()
  umcaHeightFromDiameter$sharmaParton = fit_gsl_nls("Sharma-Parton", TotalHt ~ 1.37 + a1*topHeight^b1 * (1 - exp(b2*(tph/standBasalAreaPerHectare)^b3*DBH))^b4, umca2016, start = list(a1 = 24, b1 = 0, b2 = -0.043, b3 = 0, b4 = 1.05)) # a1p, b1, b1p, b2p, b3, b3p, b4p not significant, job step factor with nlrob()
  umcaHeightFromDiameter$sharmaPartonBal = fit_gsl_nls("Sharma-Parton BA+L", TotalHt ~ 1.37 + a1*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare + basalAreaLarger))^b3*DBH))^b4, umca2016, start = list(a1 = 20, b1 = 0, b2 = -0.05, b3 = 0, b4 = 1.1)) # a1p, b1, b1p, b2p, b3, b3p, b4p not significant
  umcaHeightFromDiameter$sharmaPartonBalPhysio = fit_gsl_nls("Sharma-Parton BA+L physio", TotalHt ~ 1.37 + (a1 + a4 * elevation)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare + basalAreaLarger))^b3*DBH))^b4, umca2016physio, start = list(a1 = 22, a4 = -0.013, b1 = 0, b2 = -0.05, b3 = 0, b4 = 1.05), significant = FALSE) # a4, a5, a6, a7, a8, b1, b1p, b2p, b3, b3p, b4p not significant, job step factor with nlrob()
  umcaHeightFromDiameter$sharmaPartonBalPhysioRelDbh = fit_gsl_nls("Sharma-Parton BA+L RelDbh physio", TotalHt ~ 1.37 + (a1 + a4 * elevation + a10 * relativeDiameter)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare + basalAreaLarger))^b3*DBH))^b4, umca2016physio, start = list(a1 = 26, a4 = -0.015, a10 = 0, b1 = 0, b2 = -0.04, b3 = 0.06, b4 = 1.05), significant = FALSE) # a10, a10p not significant
  umcaHeightFromDiameter$sharmaPartonBalRelDbh = fit_gsl_nls("Sharma-Parton BA+L RelDbh", TotalHt ~ 1.37 + (a1 + a10 * relativeDiameter)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare + basalAreaLarger))^b3*DBH))^b4, umca2016, start = list(a1 = 27, a10 = 0, b1 = 0, b2 = -0.035, b3 = 0.06, b4 = 1.04), significant = FALSE) # a10, a10p not significant
  umcaHeightFromDiameter$sharmaPartonPhysio = fit_gsl_nls("Sharma-Parton physio", TotalHt ~ 1.37 + (a1 + a4 * elevation)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare))^b3*DBH))^(b4 + b4p * isPlantation), umca2016physio, start = list(a1 = 13, a4 = -0.01, b1 = 0.08, b2 = -0.05, b3 = 0.0, b4 = 1.2, b4p = -0.23)) # a5, a6, a7, a8, b1p, b2p, b3, b3p not significant, job step factor with nlrob
  umcaHeightFromDiameter$sharmaPartonRelDbh = fit_gsl_nls("Sharma-Parton RelDbh", TotalHt ~ 1.37 + (a1 + a10 * relativeDiameter)*topHeight^b1 * (1 - exp(b2*(tph/standBasalAreaPerHectare)^b3*DBH))^b4, umca2016, start = list(a1 = 24, a10 = 0, b1 = -0.05, b2 = -0.033, b3 = 0.06, b4 = 1.04), significant = FALSE) # a10, a10p not significant
  umcaHeightFromDiameter$sharmaPartonRelDbhPhysio = fit_gsl_nls("Sharma-Parton RelDbh physio", TotalHt ~ 1.37 + (a1 + a4 * elevation + a10 * relativeDiameter)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare))^b3*DBH))^(b4 + b4p * isPlantation), umca2016physio, start = list(a1 = 13, a4 = -0.008, a10 = -0.6, b1 = 0.12, b2 = -0.05, b3 = 0.06, b4 = 1.15, b4p = -0.18), significant = FALSE) # a10, a10p not significant
  umcaHeightFromDiameter$sharmaZhang = fit_gsl_nls("Sharma-Zhang", TotalHt ~ 1.37 + a1*standBasalAreaPerHectare^b1*(1 - exp(b2*tph^b3*DBH))^(b4 + b4p * isPlantation), umca2016, start = list(a1 = 13, b1 = 0.1, b2 = -0.06, b3 = 0.125, b4 = 1.1, b4p = -0.2)) # a1p, b1, b1p, b2p, b3p not significant, job step factor with nlrob()
  umcaHeightFromDiameter$sharmaZhangBal = fit_gsl_nls("Sharma-Zhang BA+L", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger)*standBasalAreaPerHectare^b1 * (1 - exp(b2*tph^b3*DBH))^b4, umca2016, start = list(a1 = 17, a2 = 0.04, b1 = 0, b2 = -0.03, b3 = 0.07, b4 = 1.05), significant = FALSE) # a1p, a2, a2p, b1, b1p, b2, b2p, b4p not significant, job step factor with nlrob()
  umcaHeightFromDiameter$sibbesen = fit_gsl_nls("Sibbesen", TotalHt ~ 1.37 + (a1 + a1p * isPlantation)*DBH^(b1*DBH^(b2 + b2p * isPlantation)), umca2016, start = list(a1 = 0.3, a1p = 0.1, b1 = 2.0, b2 = -0.16, b2p = -0.03)) # b1p not significant
  umcaHeightFromDiameter$weibull = fit_gsl_nls("Weibull", TotalHt ~ 1.37 + a1*(1 - exp(b1*DBH^b2)), umca2016, start = list(a1 = 18, b1 = -0.04, b2 = 1.0)) # a1p, b1p, b2p not significant
  umcaHeightFromDiameter$weibullBal = fit_gsl_nls("Weibull BA+L", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger) * (1 - exp(b1*DBH^b2)), umca2016, start = list(a1 = 18, a2 = 0.03, b1 = -0.044, b2 = 1.0), significant = FALSE) # a1p, a2, a2p, a3, a3p, b1p, b2p not significant
  umcaHeightFromDiameter$weibullBalRelHt = fit_gsl_nls("Weibull BA+L RelHt", TotalHt ~ 1.37 + (a1 + a2*basalAreaLarger + a9*pmin(relativeHeight, 1.5)) * (1 - exp((b1 + b1p * isPlantation) * DBH^b2)), umca2016, start = list(a1 = 0, a2 = 0.05, a9 = 55, b1 = -0.5, b1p = 0.3, b2 = 0.4), control = nls.control(maxiter = 500)) # a1, a1p, a2p, a3, a3p, a9p, b2p not significant
  
  if (umcaOptions$fitHeightNlrob)
  {
    umcaHeightFromDiameterNlrob = list(chapmanRichards = fit_nlrob("Chapman-Richards", TotalHt ~ 1.37 + a1 * (1 - exp(b1*DBH))^b2, umca2016, start = list(a1 = 18, b1 = -0.05, b2 = 1.06)))
    umcaHeightFromDiameterNlrob$chapmanRichardsBal = fit_nlrob("Chapman-Richards BA+L", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger) * (1 - exp(b1*DBH))^b2, umca2016, start = list(a1 = 18, a2 = 0.02, b1 = -0.04, b2 = 1.05), control = nls.control(maxiter = 250, tol = 1E-4), significant = FALSE) # job step factor
    umcaHeightFromDiameterNlrob$chapmanRichardsBalPhysio = fit_nlrob("Chapman-Richards BA+L physio", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger + a4 * elevation) * (1 - exp(b1*DBH))^b2, umca2016physio, start = list(a1 = 20, a2 = 0, a4 = -0.014, b1 = -0.05, b2 = 1.1), nls.control(tol = 0.001), significant = FALSE) # job step factor
    #umcaHeightFromDiameterNlrob$chapmanRichardsBalRelHt = fit_nlrob("Chapman-Richards BA+L RelHt", TotalHt ~ 1.37 + (a1 + a3 * standBasalAreaPerHectare + (a9 + a9p * isPlantation) * relativeHeight) * (1 - exp(b1*DBH))^(b2 + b2p * isPlantation), umca2016, start = list(a1 = -1.9, a3 = 0.03, a9 = 57, a9p = -16, b1 = -0.07, b2 = 0.23, b2p = 0.22), control = nls.control(maxiter = 250)) # NaN-inf
    umcaHeightFromDiameterNlrob$chapmanRichardsBalPhysioRelDbh = fit_nlrob("Chapman-Richards BA+L RelDbh physio", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger + a4 * elevation + a10 * relativeDiameter) * (1 - exp(b1*DBH))^b2, umca2016physio, start = list(a1 = 20, a2 = 0.03, a4 = -0.01, a10 = 0, b1 = -0.05, b2 = 1.06), control = nls.control(tol = 1E-4), significant = FALSE) # job step factor
    umcaHeightFromDiameterNlrob$chapmanRichardsBalRelDbh = fit_nlrob("Chapman-Richards BA+L RelDbh", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger + a10 * relativeDiameter) * (1 - exp(b1*DBH))^b2, umca2016, start = list(a1 = 18, a2 = 0.015, a10 = 0, b1 = -0.05, b2 = 1.1), control = nls.control(tol = 0.001), significant = FALSE) # job step factor
    umcaHeightFromDiameterNlrob$chapmanRichardsPhysio = fit_nlrob("Chapman-Richards physio", TotalHt ~ 1.37 + (a1 + a4 * elevation) * (1 - exp(b1*DBH))^b2, umca2016physio, start = list(a1 = 20, a4 = -0.014, b1 = -0.05, b2 = 1.1), significant = FALSE)
    umcaHeightFromDiameterNlrob$chapmanRichardsRelDbh = fit_nlrob("Chapman-Richards RelDbh", TotalHt ~ 1.37 + (a1 + a10 * relativeDiameter) * (1 - exp(b1*DBH))^b2, umca2016, start = list(a1 = 18, a10 = 0, b1 = -0.05, b2 = 1.05), control = nls.control(tol = 0.001), significant = FALSE) # job step factor
    #umcaHeightFromDiameterNlrob$chapmanRichardsRelDbhPhysio = fit_nlrob("Chapman-Richards RelDbh physio", TotalHt ~ 1.37 + (a1 + a4 * elevation + a10 * relativeDiameter) * (1 - exp(b1*DBH))^b2, umca2016physio, start = list(a1 = 21, a4 = -0.012, a10 = 0, b1 = -0.05, b2 = 1.1), control = nls.control(maxiter = 100, tol = 1), significant = FALSE) # always job step factor
    umcaHeightFromDiameterNlrob$curtis = fit_nlrob("Curtis", TotalHt ~ 1.37 + a1 * DBH / (1 + DBH)^b1, umca2016, start = list(a1 = 1.6, b1 = 0.4)) # a1p, b1p not significant
    umcaHeightFromDiameterNlrob$hossfeld = fit_nlrob("Hossfeld IV", TotalHt ~ 1.37 + (a1 + a1p * isPlantation) / (1 + (b1 + b1p * isPlantation) *DBH^b2), umca2016, start = list(a1 = 21.4, a1p = -4.37, b1 = 43.8, b1p = -19.9, b2 = -1.27))
    umcaHeightFromDiameterNlrob$korf = fit_nlrob("Korf", TotalHt ~ 1.37 + a1*exp((b1 + b1p * isPlantation)*DBH^b2), umca2016, start = list(a1 = 49.8, b1 = -5.02, b1p = 0.404, b2 = -0.386))
    umcaHeightFromDiameterNlrob$michaelisMenten = fit_nlrob("Michaelis-Menten", TotalHt ~ 1.37 + (a1 + a1p*isPlantation)*DBH^b1 / (a2 + a2p * isPlantation + DBH^b1), umca2016, start = list(a1 = 21.4, a1p = -4.37, a2 = 43.8, a2p = -20.0, b1 = 1.27))
    umcaHeightFromDiameterNlrob$prodan = fit_nlrob("Prodan", TotalHt ~ 1.37 + DBH^2 / ((a1 + a1p * isPlantation) * DBH^2 + (a2 + a2p * isPlantation)*DBH + a3), umca2016, start = list(a1 = 0.037, a1p = 0.020, a2 = 1.109, a2p = -0.472, a3 = 1.242))
    umcaHeightFromDiameterNlrob$power = fit_nlrob("power", TotalHt ~ 1.37 + (a1 + a1p * isPlantation)*DBH^b1, umca2016, start = list(a1 = 0.821, a1p = 0.206, b1 = 0.810))
    umcaHeightFromDiameterNlrob$ratkowsky = fit_nlrob("Ratkowsky", TotalHt ~ 1.37 + a1*exp((b1 + b1p * isPlantation)/(DBH + b2)), umca2016, start = list(a1 = 21.6, b1 = -16.5, b1p = 1.974, b2 = 3.629))
    umcaHeightFromDiameterNlrob$richardsW = fit_nlrob("unified Richards", TotalHt ~ 1.37 + (Ha + Hap * isPlantation) * (1 + ((1.37/(Ha + Hap * isPlantation))^(1 - d) - 1) * exp((-(kU + kUp * isPlantation) * DBH)/d^(d/(1 - d))))^(1/(1 - d)), umca2016, start = list(Ha = 17.0, Hap = -3.3, d = 1.03, kU = 0.032, kUp = 0.013), control = nls.control(maxiter = 100, tol = 1E-4)) # job step factor
    umcaHeightFromDiameterNlrob$sharmaParton = fit_nlrob("Sharma-Parton", TotalHt ~ 1.37 + a1*topHeight^b1 * (1 - exp(b2*(tph/standBasalAreaPerHectare)^b3*DBH))^b4, umca2016, start = list(a1 = 40, b1 = -0.2, b2 = -0.05, b3 = 0, b4 = 1.2), control = nls.control(tol = 0.001)) # b3 not significant, job step factor
    umcaHeightFromDiameterNlrob$sharmaPartonBal = fit_nlrob("Sharma-Parton BA+L", TotalHt ~ 1.37 + a1*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare + basalAreaLarger))^b3*DBH))^(b4 + b4p * isPlantation), umca2016, start = list(a1 = 15, b1 = 0, b2 = -0.06, b3 = 0, b4 = 1.2, b4p = -0.20), control = nls.control(maxiter = 100, tol = 0.001)) # job step factor
    umcaHeightFromDiameterNlrob$sharmaPartonBalPhysio = fit_nlrob("Sharma-Parton BA+L physio", TotalHt ~ 1.37 + (a1 + a4 * elevation)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare + basalAreaLarger))^b3*DBH))^(b4 + b4p * isPlantation), umca2016physio, start = list(a1 = 16, a4 = -0.01, b1 = 0.1, b2 = -0.06, b3 = 0, b4 = 1.2, b4p = -0.22), control = nls.control(maxiter = 100, tol = 1E-4)) # job step factor
    umcaHeightFromDiameterNlrob$sharmaPartonBalPhysioRelDbh = fit_nlrob("Sharma-Parton BA+L RelDbh physio", TotalHt ~ 1.37 + (a1 + a4 * elevation + a10 * relativeDiameter)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare + basalAreaLarger))^b3*DBH))^b4, umca2016physio, start = list(a1 = 31, a4 = -0.019, a10 = 0, b1 = -0.05, b2 = -0.04, b3 = 0.06, b4 = 1.09), control = nls.control(maxiter = 100, tol = 1E-4), significant = FALSE) # job step factor
    umcaHeightFromDiameterNlrob$sharmaPartonBalRelDbh = fit_nlrob("Sharma-Parton BA+L RelDbh", TotalHt ~ 1.37 + (a1 + a10 * relativeDiameter)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare + basalAreaLarger))^b3*DBH))^b4, umca2016, start = list(a1 = 50, a10 = 0, b1 = -0.3, b2 = -0.037, b3 = 0, b4 = 1.04), control = nls.control(tol = 1E-4), significant = FALSE) # job step factor
    umcaHeightFromDiameterNlrob$sharmaPartonPhysio = fit_nlrob("Sharma-Parton physio", TotalHt ~ 1.37 + (a1 + a4 * elevation)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare))^b3*DBH))^b4, umca2016physio, start = list(a1 = 25, a4 = -0.025, b1 = -0.2, b2 = -0.04, b3 = 0, b4 = 1.1), control = nls.control(tol = 1E-4)) # b3 not significant, job step factor
    umcaHeightFromDiameterNlrob$sharmaPartonRelDbh = fit_nlrob("Sharma-Parton RelDbh", TotalHt ~ 1.37 + (a1 + a10 * relativeDiameter)*topHeight^b1 * (1 - exp(b2*(tph/standBasalAreaPerHectare)^b3*DBH))^b4, umca2016, start = list(a1 = 50, a10 = -4, b1 = -0.2, b2 = -0.04, b3 = 0, b4 = 1.05), control = nls.control(tol = 0.001), significant = FALSE) # b3 not significant, job step factor
    umcaHeightFromDiameterNlrob$sharmaPartonRelDbhPhysio = fit_nlrob("Sharma-Parton RelDbh physio", TotalHt ~ 1.37 + (a1 + a4 * elevation + a10 * relativeDiameter)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare))^b3*DBH))^(b4 + b4p * isPlantation), umca2016physio, start = list(a1 = 13, a4 = -0.008, a10 = 0, b1 = 0.12, b2 = -0.05, b3 = 0.05, b4 = 1.2, b4p = -0.3), control = nls.control(tol = 0.001), significant = FALSE) # job step factor
    umcaHeightFromDiameterNlrob$sharmaZhang = fit_nlrob("Sharma-Zhang", TotalHt ~ 1.37 + a1*standBasalAreaPerHectare^b1*(1 - exp(b2*tph^b3*DBH))^b4, umca2016, start = list(a1 = 17, b1 = 0, b2 = -0.03, b3 = 0.1, b4 = 1.1), control = nls.control(tol = 1E-4)) # job step factor
    umcaHeightFromDiameterNlrob$sharmaZhangBal = fit_nlrob("Sharma-Zhang BA+L", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger)*standBasalAreaPerHectare^b1 * (1 - exp(b2*tph^b3*DBH))^b4, umca2016, start = list(a1 = 18, a2 = 0.03, b1 = 0, b2 = -0.03, b3 = 0.10, b4 = 1.08), control = nls.control(tol = 1E-4), significant = FALSE) # job step factor
    umcaHeightFromDiameterNlrob$sibbesen = fit_nlrob("Sibbesen", TotalHt ~ 1.37 + (a1 + a1p * isPlantation)*DBH^(b1*DBH^(b2 + b2p * isPlantation)), umca2016, start = list(a1 = 0.3, a1p = 0.1, b1 = 2.0, b2 = -0.16, b2p = -0.03))
    umcaHeightFromDiameterNlrob$weibull = fit_nlrob("Weibull", TotalHt ~ 1.37 + a1*(1 - exp(b1*DBH^b2)), umca2016, start = list(a1 = 18, b1 = -0.04, b2 = 1.0))
    umcaHeightFromDiameterNlrob$weibullBal = fit_nlrob("Weibull BA+L", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger) * (1 - exp(b1*DBH^b2)), umca2016, start = list(a1 = 17.5, a2 = 0.02, b1 = -0.044, b2 = 1.05), significant = FALSE)
    umcaHeightFromDiameterNlrob$weibullBalRelHt = fit_nlrob("Weibull BA+L RelHt", TotalHt ~ 1.37 + (a1 + a2*basalAreaLarger + a9*pmin(relativeHeight, 1.5)) * (1 - exp((b1 + b1p * isPlantation) * DBH^b2)), umca2016, start = list(a1 = -1.2, a2 = 0.03, a9 = 58, b1 = -0.8, b1p = 0.5, b2 = 0.4), control = nls.control(maxiter = 500))
    #confint_nlrob(umcaHeightFromDiameterNlrob$sharmaZhangBal, level = 0.99, weights = pmin(umca2016$DBH^-0.8, 1))
  } else {
    umcaHeightFromDiameterNlrob = list()
  }
  
  umcaHeightFromDiameterGslNlsDefault = list(chapmanRichards = fit_gsl_nls("Chapman-Richards", TotalHt ~ 1.37 + a1 * (1 - exp(b1*DBH))^b2, umca2016defaultWeight, start = list(a1 = 18, b1 = -0.05, b2 = 1.06)))
  umcaHeightFromDiameterGslNlsDefault$chapmanRichardsBal = fit_gsl_nls("Chapman-Richards BA+L", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger) * (1 - exp(b1*DBH))^b2, umca2016defaultWeight, start = list(a1 = 17.4, a2 = 0.03, b1 = -0.05, b2 = 1.08), significant = FALSE)
  umcaHeightFromDiameterGslNlsDefault$chapmanRichardsBalPhysio = fit_gsl_nls("Chapman-Richards BA+L physio", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger + a4 * elevation) * (1 - exp(b1*DBH))^b2, umca2016defaultWeightPhysio, start = list(a1 = 19.5, a2 = 0.03, a4 = -0.012, b1 = -0.05, b2 = 1.1), significant = FALSE)
  umcaHeightFromDiameterGslNlsDefault$chapmanRichardsBalRelHt = fit_gsl_nls("Chapman-Richards BA+L RelHt", TotalHt ~ 1.37 + (a1 + a3 * standBasalAreaPerHectare + (a9 + a9p * isPlantation) * relativeHeight) * (1 - exp(b1*DBH))^b2, umca2016defaultWeight, start = list(a1 = -1.7, a3 = 0.042, a9 = 52, a9p = -16, b1 = -0.1, b2 = 0.45))
  umcaHeightFromDiameterGslNlsDefault$chapmanRichardsBalPhysioRelDbh = fit_gsl_nls("Chapman-Richards BA+L RelDbh physio", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger + a4 * elevation + a10 * relativeDiameter) * (1 - exp(b1*DBH))^b2, umca2016defaultWeightPhysio, start = list(a1 = 20, a2 = 0, a4 = -0.01, a10 = 0, b1 = -0.05, b2 = 1.1), significant = FALSE)
  umcaHeightFromDiameterGslNlsDefault$chapmanRichardsBalRelDbh = fit_gsl_nls("Chapman-Richards BA+L RelDbh", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger + a10 * relativeDiameter) * (1 - exp(b1*DBH))^b2, umca2016defaultWeight, start = list(a1 = 17, a2 = 0, a10 = 0, b1 = -0.05, b2 = 1.08), significant = FALSE)
  umcaHeightFromDiameterGslNlsDefault$chapmanRichardsPhysio = fit_gsl_nls("Chapman-Richards physio", TotalHt ~ 1.37 + (a1 + a4 * elevation) * (1 - exp(b1*DBH))^b2, umca2016defaultWeightPhysio, start = list(a1 = 20, a4 = -0.014, b1 = -0.05, b2 = 1.1), significant = FALSE)
  umcaHeightFromDiameterGslNlsDefault$chapmanRichardsRelDbh = fit_gsl_nls("Chapman-Richards RelDbh", TotalHt ~ 1.37 + (a1 + a10 * relativeDiameter) * (1 - exp(b1*DBH))^b2, umca2016defaultWeight, start = list(a1 = 18, a10 = 0, b1 = -0.05, b2 = 1.08), significant = FALSE)
  umcaHeightFromDiameterGslNlsDefault$chapmanRichardsRelDbhPhysio = fit_gsl_nls("Chapman-Richards RelDbh physio", TotalHt ~ 1.37 + (a1 + a4 * elevation + a10 * relativeDiameter) * (1 - exp(b1*DBH))^b2, umca2016defaultWeightPhysio, start = list(a1 = 20, a4 = -0.012, a10 = 0, b1 = -0.05, b2 = 1.1), significant = FALSE)
  umcaHeightFromDiameterGslNlsDefault$curtis = fit_gsl_nls("Curtis", TotalHt ~ 1.37 + a1 * DBH / (1 + DBH)^b1, umca2016defaultWeight, start = list(a1 = 1.6, b1 = 0.4))
  umcaHeightFromDiameterGslNlsDefault$hossfeld = fit_gsl_nls("Hossfeld IV", TotalHt ~ 1.37 + (a1 + a1p * isPlantation) / (1 + (b1 + b1p * isPlantation) *DBH^b2), umca2016defaultWeight, start = list(a1 = 21.4, a1p = -4.37, b1 = 43.8, b1p = -19.9, b2 = -1.27))
  umcaHeightFromDiameterGslNlsDefault$korf = fit_gsl_nls("Korf", TotalHt ~ 1.37 + a1*exp((b1 + b1p * isPlantation)*DBH^b2), umca2016defaultWeight, start = list(a1 = 49.8, b1 = -5.02, b1p = 0.404, b2 = -0.386))
  umcaHeightFromDiameterGslNlsDefault$michaelisMenten = fit_gsl_nls("Michaelis-Menten", TotalHt ~ 1.37 + (a1 + a1p*isPlantation)*DBH^b1 / (a2 + a2p * isPlantation + DBH^b1), umca2016defaultWeight, start = list(a1 = 21.4, a1p = -4.37, a2 = 43.8, a2p = -20.0, b1 = 1.27))
  umcaHeightFromDiameterGslNlsDefault$prodan = fit_gsl_nls("Prodan", TotalHt ~ 1.37 + DBH^2 / ((a1 + a1p * isPlantation) * DBH^2 + (a2 + a2p * isPlantation)*DBH + a3), umca2016defaultWeight, start = list(a1 = 0.037, a1p = 0.020, a2 = 1.109, a2p = -0.472, a3 = 1.242))
  umcaHeightFromDiameterGslNlsDefault$power = fit_gsl_nls("power", TotalHt ~ 1.37 + (a1 + a1p * isPlantation)*DBH^b1, umca2016defaultWeight, start = list(a1 = 0.821, a1p = 0.206, b1 = 0.810))
  umcaHeightFromDiameterGslNlsDefault$ratkowsky = fit_gsl_nls("Ratkowsky", TotalHt ~ 1.37 + a1*exp((b1 + b1p * isPlantation)/(DBH + b2)), umca2016defaultWeight, start = list(a1 = 21.6, b1 = -16.5, b1p = 1.974, b2 = 3.629))
  umcaHeightFromDiameterGslNlsDefault$richardsW = fit_gsl_nls("unified Richards", TotalHt ~ 1.37 + (Ha + Hap * isPlantation) * (1 + ((1.37/(Ha + Hap * isPlantation))^(1 - d) - 1) * exp((-(kU + kUp * isPlantation) * DBH)/d^(d/(1 - d))))^(1/(1 - d)), umca2016defaultWeight, start = list(Ha = 14.6, Hap = -4.146, d = 2.198, kU = 0.048, kUp = 0.045))
  umcaHeightFromDiameterGslNlsDefault$sharmaParton = fit_gsl_nls("Sharma-Parton", TotalHt ~ 1.37 + a1*topHeight^b1 * (1 - exp(b2*(tph/standBasalAreaPerHectare)^b3*DBH))^b4, umca2016defaultWeight, start = list(a1 = 23, b1 = -0.06, b2 = -0.045, b3 = 0.055, b4 = 1.1))
  umcaHeightFromDiameterGslNlsDefault$sharmaPartonBal = fit_gsl_nls("Sharma-Parton BA+L", TotalHt ~ 1.37 + a1*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare + basalAreaLarger))^b3*DBH))^(b4 + b4p * isPlantation), umca2016defaultWeight, start = list(a1 = 14, b1 = 0.08, b2 = -0.05, b3 = 0.02, b4 = 1.2, b4p = -0.2))
  umcaHeightFromDiameterGslNlsDefault$sharmaPartonBalPhysio = fit_gsl_nls("Sharma-Parton BA+L physio", TotalHt ~ 1.37 + (a1 + a4 * elevation)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare + basalAreaLarger))^b3*DBH))^(b4 + b4p * isPlantation), umca2016defaultWeightPhysio, start = list(a1 = 12, a4 = -0.007, b1 = 0.13, b2 = -0.05, b3 = 0, b4 = 1.25, b4p = -0.25))
  umcaHeightFromDiameterGslNlsDefault$sharmaPartonBalPhysioRelDbh = fit_gsl_nls("Sharma-Parton BA+L RelDbh physio", TotalHt ~ 1.37 + (a1 + a4 * elevation + a10 * relativeDiameter)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare + basalAreaLarger))^b3*DBH))^b4, umca2016defaultWeightPhysio, start = list(a1 = 25, a4 = -0.014, a10 = 0, b1 = 0, b2 = -0.04, b3 = 0.08, b4 = 1.1), significant = FALSE)
  umcaHeightFromDiameterGslNlsDefault$sharmaPartonBalRelDbh = fit_gsl_nls("Sharma-Parton BA+L RelDbh", TotalHt ~ 1.37 + (a1 + a10 * relativeDiameter)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare + basalAreaLarger))^b3*DBH))^b4, umca2016defaultWeight, start = list(a1 = 27, a10 = 0, b1 = 0, b2 = -0.035, b3 = 0.06, b4 = 1.04), significant = FALSE)
  umcaHeightFromDiameterGslNlsDefault$sharmaPartonPhysio = fit_gsl_nls("Sharma-Parton physio", TotalHt ~ 1.37 + (a1 + a4 * elevation)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare))^b3*DBH))^b4, umca2016defaultWeightPhysio, start = list(a1 = 13, a4 = -0.01, b1 = 0.08, b2 = -0.05, b3 = 0.0, b4 = 1.2))
  umcaHeightFromDiameterGslNlsDefault$sharmaPartonRelDbh = fit_gsl_nls("Sharma-Parton RelDbh", TotalHt ~ 1.37 + (a1 + a10 * relativeDiameter)*topHeight^b1 * (1 - exp(b2*(tph/standBasalAreaPerHectare)^b3*DBH))^b4, umca2016defaultWeight, start = list(a1 = 24, a10 = -1.5, b1 = -0.05, b2 = -0.03, b3 = 0.09, b4 = 1.1), significant = FALSE)
  umcaHeightFromDiameterGslNlsDefault$sharmaPartonRelDbhPhysio = fit_gsl_nls("Sharma-Parton RelDbh physio", TotalHt ~ 1.37 + (a1 + a4 * elevation + a10 * relativeDiameter)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare))^b3*DBH))^(b4 + b4p * isPlantation), umca2016defaultWeightPhysio, start = list(a1 = 13, a4 = -0.008, a10 = 0, b1 = 0.15, b2 = -0.05, b3 = 0.03, b4 = 1.22, b4p = -0.22), significant = FALSE)
  umcaHeightFromDiameterGslNlsDefault$sharmaZhang = fit_gsl_nls("Sharma-Zhang", TotalHt ~ 1.37 + a1*standBasalAreaPerHectare^b1*(1 - exp(b2*tph^b3*DBH))^(b4 + b4p * isPlantation), umca2016defaultWeight, start = list(a1 = 10, b1 = 0.15, b2 = -0.033, b3 = 0.08, b4 = 1.23, b4p = -0.24))
  umcaHeightFromDiameterGslNlsDefault$sharmaZhangBal = fit_gsl_nls("Sharma-Zhang BA+L", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger)*standBasalAreaPerHectare^b1 * (1 - exp(b2*tph^b3*DBH))^b4, umca2016defaultWeight, start = list(a1 = 10, a2 = 0.03, b1 = 0.04, b2 = -0.04, b3 = 0.07, b4 = 1.1), significant = FALSE)
  umcaHeightFromDiameterGslNlsDefault$sibbesen = fit_gsl_nls("Sibbesen", TotalHt ~ 1.37 + (a1 + a1p * isPlantation)*DBH^(b1*DBH^(b2 + b2p * isPlantation)), umca2016defaultWeight, start = list(a1 = 0.3, a1p = 0.1, b1 = 2.0, b2 = -0.16, b2p = -0.03))
  umcaHeightFromDiameterGslNlsDefault$weibull = fit_gsl_nls("Weibull", TotalHt ~ 1.37 + a1*(1 - exp(b1*DBH^b2)), umca2016defaultWeight, start = list(a1 = 18, b1 = -0.04, b2 = 1.0))
  umcaHeightFromDiameterGslNlsDefault$weibullBal = fit_gsl_nls("Weibull BA+L", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger) * (1 - exp(b1*DBH^b2)), umca2016defaultWeight, start = list(a1 = 18, a2 = 0.02, b1 = -0.044, b2 = 1.04), significant = FALSE)
  umcaHeightFromDiameterGslNlsDefault$weibullBalRelHt = fit_gsl_nls("Weibull BA+L RelHt", TotalHt ~ 1.37 + (a1 + a2*basalAreaLarger + a9*pmin(relativeHeight, 1.5)) * (1 - exp((b1 + b1p * isPlantation) * DBH^b2)), umca2016defaultWeight, start = list(a1 = -1.0, a2 = 0.04, a9 = 55, b1 = -0.6, b1p = 0.3, b2 = 0.4), control = nls.control(maxiter = 500))
  
  umcaHeightFromDiameter$gam = fit_gam("REML GAM", TotalHt ~ s(DBH, bs = "ts", by = as.factor(isPlantation), k = 11, pc = gamConstraint), data = umca2016, constraint = umca2016gamConstraint)
  umcaHeightFromDiameter$gamBal = fit_gam("REML GAM BA+L", TotalHt ~ s(DBH, standBasalAreaPerHectare, basalAreaLarger, bs = "ts", by = as.factor(isPlantation), k = 15, pc = gamConstraint), data = umca2016, constraint = umca2016gamConstraint)
  umcaHeightFromDiameter$gamBalPhysio = fit_gam("REML GAM BA+L physio", TotalHt ~ s(DBH, basalAreaLarger, elevation, cos(3.14159/180 * aspect), bs = "ts", by = as.factor(isPlantation), k = 36, pc = gamConstraint), data = umca2016physio, constraint = umca2016gamConstraint)
  umcaHeightFromDiameter$gamBalPhysioRelDbh = fit_gam("REML GAM BA+L RelDbh physio", TotalHt ~ s(DBH, standBasalAreaPerHectare, basalAreaLarger, elevation, cos(3.14159/180 * aspect), relativeDiameter, bs = "ts", by = as.factor(isPlantation), k = 85, pc = gamConstraint), data = umca2016physio, constraint = umca2016gamConstraint)
  umcaHeightFromDiameter$gamBalRelDbh = fit_gam("REML GAM BA+L RelDbh", TotalHt ~ s(DBH, standBasalAreaPerHectare, basalAreaLarger, relativeDiameter, bs = "ts", by = as.factor(isPlantation), k = 22, pc = gamConstraint), data = umca2016, constraint = umca2016gamConstraint)
  umcaHeightFromDiameter$gamPhysio = fit_gam("REML GAM physio", TotalHt ~ s(DBH, elevation, cos(3.14159/180 * aspect), topographicShelterIndex, bs = "ts", by = as.factor(isPlantation), k = 35, pc = gamConstraint), data = umca2016physio, constraint = umca2016gamConstraint)
  umcaHeightFromDiameter$gamRelDbh = fit_gam("REML GAM RelDbh", TotalHt ~ s(DBH, relativeDiameter, bs = "ts", by = as.factor(isPlantation), k = 14, pc = gamConstraint), data = umca2016, constraint = umca2016gamConstraint)
  umcaHeightFromDiameter$gamRelDbhPhysio = fit_gam("REML GAM RelDbh physio", TotalHt ~ s(DBH, elevation, cos(3.14159/180 * aspect), topographicShelterIndex, relativeDiameter, bs = "ts", k = 57, by = as.factor(isPlantation), pc = gamConstraint), data = umca2016physio, constraint = umca2016gamConstraint)

  save(file = "trees/height-diameter/data/UMCA TotalHt.Rdata", umcaHeightFromDiameter, umcaHeightFromDiameterNlrob, umcaHeightFromDiameterGslNlsDefault)
}
if (htDiaOptions$includeInvestigatory)
{
  print(umcaHeightFromDiameterResults %>% select(-responseVariable, -species, -biasNR, -biasPl, -rmse, -rmseNR, -rmsePl, -pearsonNR, -pearsonPl, -aic, -bic), n = 25)

  ggplot() +
    geom_point(aes(x = umca2016$DBH, y = umca2016$TotalHt), alpha = 0.10, color = "grey25", shape = 16) +
    #geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$sharmaZhang), color = "Sharma-Zhang", group = umca2016$isPlantation), alpha = 0.5) +
    #geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$sharmaParton), color = "Sharma-Parton", group = umca2016$isPlantation), alpha = 0.5) +
    geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$chapmanRichards), color = "Chapman-Richards", group = umca2016$isPlantation)) +
    geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$curtis), color = "Curtis", group = umca2016$isPlantation)) +
    geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$korf), color = "Korf", group = umca2016$isPlantation)) +
    geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$linear), color = "linear", group = umca2016$isPlantation)) +
    geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$michaelisMenten), color = "Michaelis-Menten", group = umca2016$isPlantation)) +
    geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$parabolic), color = "parabolic", group = umca2016$isPlantation)) +
    geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$power), color = "power", group = umca2016$isPlantation)) +
    geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$prodan), color = "Prodan", group = umca2016$isPlantation)) +
    geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$ratkowsky), color = "Ratkowsky", group = umca2016$isPlantation)) +
    geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$richardsW), color = "unified Richards", group = umca2016$isPlantation)) +
    geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$sibbesen), color = "Sibbesen", group = umca2016$isPlantation)) +
    geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$weibull), color = "Weibull", group = umca2016$isPlantation)) +
    annotate("text", x = 0, y = 35, label = "Oregon myrtle, height from diameter", hjust = 0, size = 3.5) +
    coord_cartesian(ylim = c(0, 35)) +
    labs(x = "DBH, cm", y = "height, m", color = NULL) +
    theme(legend.justification = c(1, 0), legend.position = c(1, 0.03))
}

  
## Oregon myrtle height-diameter GNLS regressions
if (umcaOptions$fitHeightGnls)
{
  umcaHeightFromDiameterGnls = list(chapmanRichards = fit_gnls("Chapman-Richards GNLS", TotalHt ~ 1.37 + a1*(1 - exp(b1*DBH))^(b2 + b2p * isPlantation), umca2016, start = umcaHeightFromDiameter$chapmanRichards$fit[[1]]$m$getPars(), control = gnlsControl(nlsTol = 0.001))) # step halving with plot correlation
  umcaHeightFromDiameterGnls$chapmanRichardsBal = fit_gnls("Chapman-Richards BA+L GNLS", TotalHt ~ 1.37 + (a1 + a2 * basalAreaLarger + a3 * standBasalAreaPerHectare) * (1 - exp((b1 + b1p * isPlantation)*DBH))^b2, umca2016, start = umcaHeightFromDiameter$chapmanRichardsBal$fit[[1]]$m$getPars(), control = gnlsControl(nlsTol = 0.001)) # corSymm viable but dropped
  umcaHeightFromDiameterGnls$sharmaParton = fit_gnls("Sharma-Parton GNLS", TotalHt ~ 1.37 + a1*topHeight^b1 * (1 - exp((b2 + b2p * isPlantation)*(tph/standBasalAreaPerHectare)^b3*DBH))^b4, umca2016, start = umcaHeightFromDiameter$sharmaParton$fit[[1]]$m$getPars(), control = gnlsControl(nlsTol = 0.001)) # step halving with plot correlation
  umcaHeightFromDiameterGnls$sharmaPartonBal = fit_gnls("Sharma-Parton BA+L GNLS", TotalHt ~ 1.37 + a1*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare + basalAreaLarger))^b3*DBH))^(b4 + b4p * isPlantation), umca2016, start = umcaHeightFromDiameter$sharmaPartonBal$fit[[1]]$m$getPars(), control = gnlsControl(nlsTol = 0.001)) # step halving with plot correlation
  umcaHeightFromDiameterGnls$sharmaZhang = fit_gnls("Sharma-Zhang GNLS", TotalHt ~ 1.37 + a1*standBasalAreaPerHectare^b1 * (1 - exp(b2*tph^b3*DBH))^(b4 + b4p * isPlantation), umca2016, start = umcaHeightFromDiameter$sharmaZhang$fit[[1]]$m$getPars(), control = gnlsControl(nlsTol = 0.001)) # step halving with plot correlation
  umcaHeightFromDiameterGnls$sharmaZhangBal = fit_gnls("Sharma-Zhang BA+L GNLS", TotalHt ~ 1.37 + (a1 + a2*basalAreaLarger)*standBasalAreaPerHectare^b1 * (1 - exp(b2*tph^(b3 + b3p * isPlantation)*DBH))^b4, umca2016, start = umcaHeightFromDiameter$sharmaZhangBal$fit[[1]]$m$getPars(), control = gnlsControl(nlsTol = 0.005, maxIter = 250, nlsMaxIter = 50)) # step halving with plot correlation or nlsTol = 0.001
  umcaHeightFromDiameterGnls$weibull = fit_gnls("Weibull GNLS", TotalHt ~ 1.37 + (a1 + a1p * isPlantation)*(1 - exp((b1 + b1p * isPlantation)*DBH^b2)), umca2016, start = umcaHeightFromDiameter$weibull$fit[[1]]$m$getPars(), control = gnlsControl(nlsTol = 0.001)) # step halving with plot correlation
  umcaHeightFromDiameterGnls$weibullBal = fit_gnls("Weibull BA+L GNLS", TotalHt ~ 1.37 + (a1 + a2*basalAreaLarger + a3*standBasalAreaPerHectare) * (1 - exp((b1 + b1p * isPlantation)*DBH^b2)), umca2016, start = umcaHeightFromDiameter$weibullBal$fit[[1]]$m$getPars(), control = gnlsControl(nlsTol = 0.001, maxIter = 250, nlsMaxIter = 50)) # corSymm viable but dropped

  save(file = "trees/height-diameter/data/UMCA GNLS.rdata", umcaHeightFromDiameterGnls)
}
if (htDiaOptions$includeInvestigatory)
{
  umcaHeightFromDiameterResultsGnls %>% select(-responseVariable, -species, -biasNR, -biasPl, -rmse, -rmseNR, -rmsePl, -pearsonNR, -pearsonPl, -aic, -bic) %>% arrange(method)
  
  #bind_cols(parameter = c("a1", "a2", "a3", "b1", "b2"), bal = confint2(umcaHeightFromDiameter$weibullBAL, level = 0.99), balN = confint2(umcaHeightFromDiameter$weibullBalNatural, level = 0.99), balP = confint2(umcaHeightFromDiameter$weibullBalPlantation, level = 0.99)) %>%
  #  mutate(bal005 = bal[, 1], bal995 = bal[, 2], balN005 = balN[, 1], balN995 = balN[, 2], balP005 = balP[, 1], balP995 = balP[, 2]) %>%
  #  select(-bal, -balN, -balP)
  
  ggplot() +
    geom_point(aes(x = umca2016natural$DBH, y = umca2016natural$TotalHt), alpha = 0.15, color = "navyblue", na.rm = TRUE, shape = 16) +
    geom_smooth(aes(x = umca2016natural$DBH, y = umca2016natural$TotalHt), alpha = 0.20, color = "red", formula = y ~ s(x, k = 20), method = "gam", size = 0.5) +
    coord_cartesian(xlim = c(0, 250), ylim = c(0, 85)) +
    labs(x = "natural regeneration DBH, cm", y = "Oregon myrtle naturally regenerated height, m") +
  ggplot() +
    geom_point(aes(x = umca2016plantation$DBH, y = umca2016plantation$TotalHt), alpha = 0.15, color = "black", na.rm = TRUE, shape = 16) +
    geom_smooth(aes(x = umca2016plantation$DBH, y = umca2016plantation$TotalHt), alpha = 0.20, color = "red", formula = y ~ s(x, k = 20), method = "gam", size = 0.5) +
    coord_cartesian(xlim = c(0, 250), ylim = c(0, 85)) +
    labs(x = "plantation DBH, cm", y = "Oregon myrtle plantation height, m")
  
  ggplot() +
    geom_point(aes(x = umca2016$DBH, y = umca2016$TotalHt), alpha = 0.15, color = "black", na.rm = TRUE, shape = 16) +
    geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$weibullBAL), color = "ElliottBAL"), alpha = 0.5) + # Temesgen et al. 2007, Eq. 5
    geom_line(aes(x = umca2016natural$DBH, y = predict(umcaHeightFromDiameter$weibullBALnatural), color = "ElliottBALn"), alpha = 0.5) + # Temesgen et al. 2007, Eq. 5
    geom_line(aes(x = umca2016plantation$DBH, y = predict(umcaHeightFromDiameter$weibullBALplantation), color = "ElliottBALp"), alpha = 0.5) + # Temesgen et al. 2007, Eq. 5
    geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$Base), color = "base")) +
    geom_line(aes(x = umca2016$DBH, y = predict(umcaHeightFromDiameter$weibull), color = "ElliottWeibull")) +
    annotate("text", x = 0, y = 85, label = "a) Oregon myrtle, height from diameter", hjust = 0, size = 3.5) +
    coord_cartesian(xlim = c(0, 250), ylim = c(0, 85)) +
    labs(x = "DBH, cm", y = "height, m", color = NULL) +
    scale_color_manual(breaks = c("base", "ElliottWeibull", "ElliottBAL", "ElliottBALn", "ElliottBALp", "TemesgenWeibull"), labels = c(bquote("1.37 + b"[0]*"DBH"^{b[1]}), "Weibull", "Weibull with BA+L", "Weibull with BA+L, natural regeneration", "Weibull with BA+L, plantation", "Weibull, Temesgen et al. 2007"), values = c("#ac92eb", "#4dc1e8", "#a0d568", "#ffce54", "#ed5564", "grey65")) +
    scale_y_continuous(breaks = seq(0, 100, by = 20)) +
    theme(legend.justification = c(1, 0), legend.position = c(0.99, 0.03))
}


## other height-diameter nlme regressions
if (umcaOptions$fitHeightMixed)
{
  umcaHeightFromDiameterMixed = list(chapmanRichards = fit_nlme("Chapman-Richards", TotalHt ~ 1.37 + (a1 + a1r) * (1 - exp(b1*DBH))^b2, umca2016, 
                                                                fixedFormula = a1 + b1 + b2 ~ 1, randomFormula = a1r ~ 1,
                                                                start = list(fixed = c(a1 = 16, b1 = -0.063, b2 = 1.1)), control = nlmeControl(maxIter = 500, tolerance = 0.001, pnlsTol = 0.1, msTol = 1E-4))) # step halving, max iterations, singularity in backsolve
  umcaHeightFromDiameterMixed$chapmanRichardsBal = fit_nlme("Chapman-Richards BA+L", TotalHt ~ 1.37 + (a1 + a1r + a2 * basalAreaLarger) * (1 - exp(b1*DBH))^b2, umca2016, 
                                                            fixedFormula = a1 + a2 + b1 + b2 ~ 1, randomFormula = a1r ~ 1,
                                                            start = list(fixed = c(a1 = 18, a2 = 0.23, b1 = -0.04, b2 = 1.0)), significant = FALSE)
  umcaHeightFromDiameterMixed$chapmanRichardsBalPhysio = fit_nlme("Chapman-Richards BA+L physio", TotalHt ~ 1.37 + (a1 + a1r + a2 * basalAreaLarger + a4 * elevation) * (1 - exp(b1*DBH))^b2, umca2016physio,
                                                                  fixedFormula = a1 + a2 + a4 + b1 + b2 ~ 1, randomFormula = a1r ~ 1,
                                                                  start = list(fixed = c(a1 = 18, a2 = -0.031, a4 = -0.01, b1 = -0.07, b2 = 1.1)), control = nlmeControl(maxIter = 500), significant = FALSE)
  #umcaHeightFromDiameterMixed$chapmanRichardsPhysio = fit_nlme("Chapman-Richards physio", TotalHt ~ 1.37 + (a1 + a1r + a4 * elevation) * (1 - exp(b1*DBH))^b2, umca2016physio,
  #                                                             fixedFormula = a1 + a4 + b1 + b2 ~ 1, randomFormula = a1r ~ 1,
  #                                                             start = list(fixed = c(a1 = 18, a4 = -0.07, b1 = -0.0, b2 = 1.1)), control = nlmeControl(maxIter = 500, tolerance = 0.01, pnlsTol = 1, msTol = 0.001), significant = FALSE) # singularity in backsolve, leading minor not positive definite
  umcaHeightFromDiameterMixed$curtis = fit_nlme("Curtis", TotalHt ~ 1.37 + (a1 + a1r) * DBH / (1 + DBH)^b1, umca2016, 
                                                fixedFormula = a1 + b1 ~ 1, randomFormula = a1r ~ 1,
                                                start = list(fixed = c(a1 = 1.6, b1 = 0.4)), control = nlmeControl(maxIter = 500))
  umcaHeightFromDiameterMixed$hossfeld = fit_nlme("Hossfeld IV", TotalHt ~ 1.37 + (a1 + a1p * isPlantation + a1r) / (1 + (b1 + b1p * isPlantation) *DBH^b2), umca2016, 
                                                  fixedFormula = a1 + a1p + b1 + b1p + b2 ~ 1, randomFormula = a1r ~ 1,
                                                  start = list(fixed = c(a1 = 19, a1p = -8, b1 = 49, b1p = -37, b2 = -1.4)), control = nlmeControl(maxIter = 500, tolerance = 0.01, pnlsTol = 1, msTol = 0.001)) # max iterations
  umcaHeightFromDiameterMixed$korf = fit_nlme("Korf", TotalHt ~ 1.37 + (a1 + a1r)*exp((b1 + b1p * isPlantation)*DBH^b2), umca2016, 
                                              fixedFormula = a1 + b1 + b1p + b2 ~ 1, randomFormula = a1r ~ 1,
                                              start = list(fixed = c(a1 = 49.8, b1 = -5.02, b1p = 0.404, b2 = -0.386)), control = nlmeControl(maxIter = 500, tolerance = 0.01, pnlsTol = 1, msTol = 0.001)) # max iterations
  umcaHeightFromDiameterMixed$michaelisMenten = fit_nlme("Michaelis-Menten", TotalHt ~ 1.37 + (a1 + a1p*isPlantation + a1r)*DBH^b1 / (a2 + a2p * isPlantation + DBH^b1), umca2016, 
                                                         fixedFormula = a1 + a1p + a2 + a2p + b1 ~ 1, randomFormula = a1r ~ 1,
                                                         start = list(fixed = c(a1 = 21.4, a1p = -4.37, a2 = 43.8, a2p = -20.0, b1 = 1.27)))
  umcaHeightFromDiameterMixed$prodan = fit_nlme("Prodan", TotalHt ~ 1.37 + DBH^2 / ((a1 + a1p * isPlantation) * DBH^2 + (a2 + a2p * isPlantation)*DBH + a3 + a3r), umca2016, 
                                                fixedFormula = a1 + a1p + a2 + a2p + a3 ~ 1, randomFormula = a3r ~ 1,
                                                start = list(fixed = c(a1 = 0.037, a1p = 0.020, a2 = 1.109, a2p = -0.472, a3 = 1.242)), control = nlmeControl(maxIter = 500, tolerance = 0.1, pnlsTol = 1, msTol = 0.01)) # job max iterations
  umcaHeightFromDiameterMixed$power = fit_nlme("power", TotalHt ~ 1.37 + (a1 + a1p * isPlantation + a1r)*DBH^b1, umca2016,
                                               fixedFormula = a1 + a1p + b1 ~ 1, randomFormula = a1r ~ 1,
                                               start = list(fixed = c(a1 = 0.821, a1p = 0.206, b1 = 0.810)))
  umcaHeightFromDiameterMixed$ratkowsky = fit_nlme("Ratkowsky", TotalHt ~ 1.37 + (a1 + a1r)*exp((b1 + b1p * isPlantation)/(DBH + b2)), umca2016,
                                                   fixedFormula = a1 + b1 + b1p + b2 ~ 1, randomFormula = a1r ~ 1,
                                                   start = list(fixed = c(a1 = 21.6, b1 = -16.5, b1p = 1.974, b2 = 3.629)))
  umcaHeightFromDiameterMixed$richardsW = fit_nlme("unified Richards", TotalHt ~ 1.37 + (Ha + Hap * isPlantation + Har) * (1 + ((1.37/(Ha + Hap * isPlantation + Har))^(1 - d) - 1) * exp((-(kU + kUp * isPlantation) * DBH)/d^(d/(1 - d))))^(1/(1 - d)), umca2016,
                                                   fixedFormula = Ha + Hap + d + kU + kUp ~ 1, randomFormula = Har ~ 1,
                                                   start = list(fixed = c(Ha = 14.6, Hap = -4.146, d = 2.198, kU = 0.048, kUp = 0.045)), control = nlmeControl(maxIter = 500, tolerance = 0.01, pnlsTol = 1, msTol = 0.001)) # job step halving, max iterations
  #umcaHeightFromDiameterMixed$sharmaParton = fit_nlme("Sharma-Parton", TotalHt ~ 1.37 + (a1 + a1r)*topHeight^b1 * (1 - exp(b2*(tph/standBasalAreaPerHectare)^b3*DBH))^b4, umca2016,
  #                                                    fixedFormula = a1 + b1 + b2 + b3 + b4 ~ 1, randomFormula = a1r ~ 1,
  #                                                    start = list(fixed = c(a1 = 24, b1 = 0, b2 = -0.043, b3 = 0, b4 = 1.05)), control = nlmeControl(tolerance = 0.01, pnlsTol = 1, msTol = 0.001)) # singularity in backsolve
  #umcaHeightFromDiameterMixed$sharmaPartonBal = fit_nlme("Sharma-Parton BA+L", TotalHt ~ 1.37 + (a1 + a1r)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare + basalAreaLarger))^b3*DBH))^b4, umca2016,
  #                                                       fixedFormula = a1 + b1 + b2 + b3 + b4 ~ 1, randomFormula = a1r ~ 1,
  #                                                       start = list(fixed = c(a1 = 20, b1 = 0, b2 = -0.05, b3 = 0, b4 = 1.1)), control = nlmeControl(tolerance = 0.01, pnlsTol = 1, msTol = 0.001)) # singularity in backsolve
  #umcaHeightFromDiameterMixed$sharmaPartonBalPhysio = fit_nlme("Sharma-Parton BA+L physio", TotalHt ~ 1.37 + (a1 + a1r + a4 * elevation)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare + basalAreaLarger))^b3*DBH))^b4, umca2016physio,
  #                                                             fixedFormula = a1 + a4 + b1 + b2 + b3 + b4 ~ 1, randomFormula = a1r ~ 1,
  #                                                             start = list(fixed = c(a1 = 22, a4 = -0.013, b1 = 0, b2 = -0.05, b3 = 0, b4 = 1.05)), control = nlmeControl(tolerance = 0.01, pnlsTol = 1, msTol = 0.001), significant = FALSE) # singularity in backsolve
  #umcaHeightFromDiameterMixed$sharmaPartonPhysio = fit_nlme("Sharma-Parton physio", TotalHt ~ 1.37 + (a1 + a1r + a4 * elevation)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare))^b3*DBH))^(b4 + b4p * isPlantation), umca2016physio, 
  #                                                          fixedFormula = a1 + a4 + b1 + b2 + b3 + b4 + b4p ~ 1, randomFormula = a1r ~ 1,
  #                                                          start = list(fixed = c(a1 = 13, a4 = -0.01, b1 = 0.08, b2 = -0.05, b3 = 0.0, b4 = 1.2, b4p = -0.23)), control = nlmeControl(tolerance = 0.01, pnlsTol = 1, msTol = 1E-3)) # singularity in backsolve
  #umcaHeightFromDiameterMixed$sharmaZhang = fit_nlme("Sharma-Zhang", TotalHt ~ 1.37 + (a1 + a1r)*standBasalAreaPerHectare^b1*(1 - exp(b2*tph^b3*DBH))^(b4 + b4p * isPlantation), umca2016, 
  #                                                   fixedFormula = a1 + b1 + b2 + b3 + b4 + b4p ~ 1, randomFormula = a1r ~ 1,
  #                                                   start = list(fixed = c(a1 = 13, b1 = 0.1, b2 = -0.06, b3 = 0.125, b4 = 1.1, b4p = -0.2)), control = nlmeControl(tolerance = 0.01, pnlsTol = 1, msTol = 0.001)) # singularity in backsolve
  #umcaHeightFromDiameterMixed$sharmaZhangBal = fit_nlme("Sharma-Zhang BA+L", TotalHt ~ 1.37 + (a1 + a1r + a2 * basalAreaLarger)*standBasalAreaPerHectare^b1 * (1 - exp(b2*tph^b3*DBH))^b4, umca2016, 
  #                                                      fixedFormula = a1 + a2 + b1 + b2 + b3 + b4 ~ 1, randomFormula = a1r ~ 1,
  #                                                      start = list(fixed = c(a1 = 17, a2 = 0.04, b1 = 0, b2 = -0.03, b3 = 0.07, b4 = 1.05)), control = nlmeControl(tolerance = 0.01, pnlsTol = 1, msTol = 1E-3), significant = FALSE) # singularity in backsolve
  #umcaHeightFromDiameterMixed$sibbesen = fit_nlme("Sibbesen", TotalHt ~ 1.37 + (a1 + a1p * isPlantation + a1r)*DBH^(b1*DBH^(b2 + b2p * isPlantation)), umca2016, 
  #                                                fixedFormula = a1 + a1p + b1 + b2 + b2p ~ 1, randomFormula = a1r ~ 1,
  #                                                start = list(fixed = c(a1 = 0.3, a1p = 0.1, b1 = 2.0, b2 = -0.16, b2p = -0.03)), control = nlmeControl(maxIter = 100, tolerance = 0.01, pnlsTol = 1, msTol = 0.001)) # job step factor, job singularity in backsolve
  umcaHeightFromDiameterMixed$weibull = fit_nlme("Weibull", TotalHt ~ 1.37 + (a1 + a1r)*(1 - exp(b1*DBH^b2)), umca2016, 
                                                 fixedFormula = a1 + b1 + b2 ~ 1, randomFormula = a1r ~ 1,
                                                 start = list(fixed = c(a1 = 18, b1 = -0.04, b2 = 1.0)), control = nlmeControl(maxIter = 250))
  umcaHeightFromDiameterMixed$weibullBal = fit_nlme("Weibull BA+L", TotalHt ~ 1.37 + (a1 + a1r + a2 * basalAreaLarger) * (1 - exp(b1*DBH^b2)), umca2016, 
                                                    fixedFormula = a1 + a2 + b1 + b2 ~ 1, randomFormula = a1r ~ 1,
                                                    start = list(fixed = c(a1 = 16, a2 = 0.02, b1 = -0.04, b2 = 1.05)), control = nlmeControl(maxIter = 500, tolerance = 0.01, pnlsTol = 1, msTol = 0.001), significant = FALSE) # max iterations
  
  umcaHeightFromDiameterMixed$gamm = fit_gam("REML GAM", TotalHt ~ s(DBH, bs = "ts", by = as.factor(isPlantation), k = 11) + s(StandID, bs = "re"), data = umca2016, mixed = TRUE)
  umcaHeightFromDiameterMixed$gammBal = fit_gam("REML GAM BA+L", TotalHt ~ s(DBH, standBasalAreaPerHectare, basalAreaLarger, bs = "ts", by = as.factor(isPlantation), k = 15) + s(StandID, bs = "re"), data = umca2016, mixed = TRUE)
  
  save(file = "trees/height-diameter/data/UMCA TotalHt mixed.Rdata", umcaHeightFromDiameterMixed)
}

  
## Oregon myrtle diameter-height regressions
if (umcaOptions$fitDbh)
{
  umcaDiameterFromHeight = list(linear = fit_lm("linear", DBH ~ 0 + I(TotalHt - 1.37) + I(isPlantation*(TotalHt - 1.37)), umca2016))
  umcaDiameterFromHeight$parabolic = fit_lm("parabolic", DBH ~ 0 + I(TotalHt - 1.37) + I(isPlantation*(TotalHt - 1.37)) + I((TotalHt - 1.37)^2) + I(isPlantation*(TotalHt - 1.37)^2), umca2016, significant = FALSE) # collapses to linear since (TotalHt - 1.37)^2 and isPlantation*(TotalHt - 1.37)^2 not significant
  
  umcaDiameterFromHeight$chapmanReplace = fit_gsl_nls("Chapman-Richards replace", DBH ~ a1*(exp(b1*(TotalHt - 1.37)) - 1)^b2, umca2016, start = list(a1 = 20, b1 = 0.1, b2 = 0.6)) # subject to a1-b1 evaporation, NaN-inf with nls() at multiple nls_multstart() points, NaN-inf with nlrob(), job NaN-inf with gsl_nls()
  umcaDiameterFromHeight$chapmanReplaceAbat = fit_gsl_nls("Chapman-Richards replace ABA+T", DBH ~ (a1 + a2 * tallerApproxBasalArea)*(exp(b1*(TotalHt - 1.37)) - 1)^b2, umca2016, start = list(a1 = 18, a2 = 0, b1 = 0.1, b2 = 0.6), significant = FALSE) # a2 not significant, a1-b1 parameter evaporation, NaN-inf with nls(), step factor with nlrob(), step factor with default gsl_nls tolerance
  umcaDiameterFromHeight$chapmanReplaceBal = fit_gsl_nls("Chapman-Richards replace BA+L", DBH ~ (a1 + a2 * basalAreaLarger) * (exp(b1*(TotalHt - 1.37)^b2) - 1), umca2016, start = list(a1 = 1, a2 = -0.005, b1 = 1.9, b2 = 0.3)) # NaN-inf with nls(), step factor with nlrob()
  umcaDiameterFromHeight$chapmanReplaceBalRelHt = fit_gsl_nls("Chapman-Richards replace BA+L RelHt", DBH ~ (a1 + a2 * basalAreaLarger + a3 * standBasalAreaPerHectare + a9 * relativeHeight) * (exp(b1*(TotalHt - 1.37)^b2) - 1), umca2016, start = list(a1 = 0.4, a2 = -0.012, a3 = 0.01, a9 = -0.3, b1 = 2.7, b2 = 0.23)) # step factor with nls() and nlrob()
  umcaDiameterFromHeight$chapmanReplaceRelHt = fit_gsl_nls("Chapman-Richards replace RelHt", DBH ~ (a1 + a9 * pmin(relativeHeight, 1.5))*(exp(b1*(TotalHt - 1.37)^b2) - 1), umca2016, start = list(a1 = 0.9, a9 = -0.6, b1 = 1.8, b2 = 0.3)) # step factor with nls(), step factor with nlrob()
  umcaDiameterFromHeight$chapmanRichards = fit_gsl_nls("Chapman-Richards inverse", DBH ~ a1*log(1 - pmin(b1*(TotalHt - 1.37)^(b2 + b2p * isPlantation), 0.9999)), umca2016, start = list(a1 = 34, b1 = -0.047, b2 = 1.43, b2p = -0.15), control = gsl_nls_control(maxiter = 250, xtol = 1E-5)) # a1-b1 parameter evaporation, b2p debatable
  umcaDiameterFromHeight$chapmanRichardsAbat = fit_gsl_nls("Chapman-Richards inverse ABA+T", DBH ~ (a1 + a2 * tallerApproxBasalArea)*log(1 - pmin(b1*(TotalHt - 1.37)^(b2 + b2p * isPlantation), 0.9999)), umca2016, start = list(a1 = 35, a2 = -3, b1 = -0.01, b2 = 0.9, b2p = -0.2), control = gsl_nls_control(maxiter = 250, xtol = 1E-5), significant = FALSE) # a2 not significant, a1-b1 parameter evaporation
  umcaDiameterFromHeight$chapmanRichardsPhysio = fit_gsl_nls("Chapman-Richards inverse physio", DBH ~ (a1 + a5 * sin(3.14159/180 * slope))*log(1 - pmin(b1*(TotalHt - 1.37)^b2, 0.9999)), umca2016physio, start = list(a1 = 58.6, a5 = -52.7, b1 = -0.0637, b2 = 0.9), control = gsl_nls_control(maxiter = 250, xtol = 1E-5), significant = FALSE) # a1p, a4, a5, a6, a7, a8, b1p, b2p not significant, a1+a5-b1 parameter evaporation
  umcaDiameterFromHeight$chapmanRichardsRelHt = fit_gsl_nls("Chapman-Richards inverse RelHt", DBH ~ (a1 + a9 * relativeHeight)*log(1 - pmin(b1*(TotalHt - 1.37)^b2, 0.9999)), umca2016, start = list(a1 = 35, a9 = -15, b1 = -0.03, b2 = 0.9), control = gsl_nls_control(maxiter = 250, xtol = 1E-5), significant = FALSE) # a1p, a9, b1p, b2p not significant, a1-b1 parameter evaporation
  umcaDiameterFromHeight$michaelisMentenReplace = fit_gsl_nls("Michaelis-Menten replace", DBH ~ a1 * (TotalHt - 1.37)^b1 / (a2 - (TotalHt - 1.37)^b1), umca2016, start = list(a1 = 100, a2 = 100, b1 = 1)) # collapses to linear
  umcaDiameterFromHeight$naslund = fit_gsl_nls("Näslund inverse", DBH ~ (a1 + a1p * isPlantation) * sqrt(TotalHt - 1.37) / (1 + a2*sqrt(TotalHt - 1.37)), umca2016, start = list(a1 = 3.9, a1p = -1.0, a2 = -0.14)) # a2p not significant, a1p debatable
  umcaDiameterFromHeight$power = fit_gsl_nls("power", DBH ~ (a1 + a1p * isPlantation)*(TotalHt - 1.37)^(b1 + b1p * isPlantation), umca2016, start = list(a1 = 3.28, a1p = -2.10, b1 = 0.917, b1p = 0.332))
  #umcaDiameterFromHeight$powerAbat = fit_gsl_nls("power ABA+T", DBH ~ (a1 + a2 * tallerApproxBasalArea)*(TotalHt - 1.37)^(b1 + b1p * isPlantation), umca2016, start = list(a1 = 2.71, a2 = 0.00054, b1 = 0.975, b1p = -0.0696)) # a1p, a2p not significant
  #umcaDiameterFromHeight$powerPhysio = fit_gsl_nls("power physio", DBH ~ (a1 + a1p * isPlantation + a4 * elevation + a5 * sin(3.14159/180 * slope) + a6 * cos(3.14159/180 * aspect) + a8 * topographicShelterIndex)*(TotalHt - 1.37)^b1, umca2016physio, start = list(a1 = 4, a1p = -0.95, a4 = 0.002, a5 = -2.8, a6 = 0.4, a8 = 0.05, b1 = 0.94)) # a1p, a2, a7, b1p not significant, a4 debatable
  #umcaDiameterFromHeight$powerRelHt = fit_gsl_nls("power RelHt", DBH ~ (a1 + a1p * isPlantation + (a9 + a9p * isPlantation) * relativeHeight)*(TotalHt - 1.37)^b1, umca2016, start = list(a1 = 2.37, a1p = -0.887, a9 = -1.508, a9p = 1513, b1 = 1.123))
  umcaDiameterFromHeight$ruark = fit_gsl_nls("Ruark", DBH ~ a1*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016, start = list(a1 = 3.95, b1 = 0.45, b2 = 0.06)) # a1p, b1p, b2p not significant
  umcaDiameterFromHeight$ruarkAbat = fit_gsl_nls("Ruark ABA+T", DBH ~ (a1 + a2 * tallerApproxBasalArea)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016, start = list(a1 = 4.0, a2 = 0, b1 = 0.55, b2 = 0.045), significant = FALSE) # a1p, a2, a2p, a3, a3p, b1p, b2p not significant
  umcaDiameterFromHeight$ruarkAbatPhysio = fit_gsl_nls("Ruark ABA+T physio", DBH ~ (a1 + a2 * tallerApproxBasalArea + a5 * sin(3.14159/180 * slope))*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016physio, start = list(a1 = 5.5, a2 = 0, a5 = -1, b1 = 0.5, b2 = 0.04), significant = FALSE) # a2, a3 not significant
  umcaDiameterFromHeight$ruarkAbatPhysioRelHt = fit_gsl_nls("Ruark ABA+T RelHt physio", DBH ~ (a1 + a2 * tallerApproxBasalArea + a5 * sin(3.14159/180 * slope) + a9 * relativeHeight)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016physio, start = list(a1 = 5.5, a2 = -0.02, a5 = 0, a9 = -4, b1 = 0.6, b2 = 0.07)) # a2, a3, a5 not significant
  umcaDiameterFromHeight$ruarkAbatRelHt = fit_gsl_nls("Ruark ABA+T RelHt", DBH ~ (a1 + a2 * tallerApproxBasalArea + a9 * relativeHeight)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016, start = list(a1 = 4.7, a2 = -0.03, a9 = -5.5, b1 = 0.55, b2 = 0.079)) # a2, a9p not significant
  umcaDiameterFromHeight$ruarkPhysio = fit_gsl_nls("Ruark physio", DBH ~ (a1 + a5 * sin(3.14159/180 * slope))*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016physio, start = list(a1 = 6, a5 = 0, b1 = 0.6, b2 = 0.04), significant = FALSE) # a1p, a4, a5, a6, a7, a8, b1p, b2p not significant
  umcaDiameterFromHeight$ruarkRelHt = fit_gsl_nls("Ruark RelHt", DBH ~ (a1 + a9 * relativeHeight)*(TotalHt - 1.37)^(b1 + b1p * isPlantation) * exp((b2 + b2p * isPlantation) * (TotalHt - 1.37)), umca2016, start = list(a1 = 4, a9 = -2, b1 = 0.7, b1p = -0.5, b2 = 0.04, b2p = 0.08), significant = FALSE) # a9, a9p not significant
  umcaDiameterFromHeight$ruarkRelHtPhysio = fit_gsl_nls("Ruark RelHt physio", DBH ~ (a1 + a5 * sin(3.14159/180 * slope) + a9 * relativeHeight)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016physio, start = list(a1 = 6, a5 = -2, a9 = -2, b1 = 0.6, b2 = 0.05)) # a5 significant
  umcaDiameterFromHeight$schnute = fit_gsl_nls("Schnute inverse", DBH ~ -1/a1 * log(1 - (1 - exp(-a2))*(TotalHt^b1 - 1.37^b1)/(Ha^b1 - 1.3^b1)), umca2016, start = list(a1 = 0.000003, a2 = 0.002, b1 = 1.13, Ha = 177)) # NaN-inf with nlrob()
  #umcaDiameterFromHeight$sharmaParton = fit_gsl_nls("modified Sharma-Parton", DBH ~ a1*(TotalHt - 1.37)^b1*(exp(b2*(tph/topHeight)^b3*(TotalHt - 1.37)) - 1)^b4, umca2016, start = list(a1 = 0.2, b1 = 1.05, b2 = 0.000003, b3 = 0.9, b4 = -0.3), control = gsl_nls_control(maxiter = 250, xtol = 0.001)) # a1, b1, b1p, b2, b2p, b3, b3p not significant, fails to start reliably: NaN-inf with nls() at nls_multistart() point, NaN-inf or code error with nlrob(), NaN-inf with gls_nls()
  umcaDiameterFromHeight$sibbesenReplace = fit_gsl_nls("Sibbesen replace", DBH ~ a1*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016, start = list(a1 = 0.43, b1 = 2.45, b2 = -0.15)) # no significant plantation effects
  umcaDiameterFromHeight$sibbesenReplaceAbat = fit_gsl_nls("Sibbesen replace ABA+T", DBH ~ (a1 + a2 * tallerApproxBasalArea)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016, start = list(a1 = 4.0, a2 = 0, b1 = 0.5, b2 = 0.18), significant = FALSE) # a2 not significant
  umcaDiameterFromHeight$sibbesenReplaceAbatPhysio = fit_gsl_nls("Sibbesen replace ABA+T physio", DBH ~ (a1 + a2 * tallerApproxBasalArea + a4 * elevation)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016physio, start = list(a1 = 4.1, a2 = 0, a4 = 0, b1 = 0.49, b2 = 0.19), significant = FALSE) # a2, a3, a4 not significant
  umcaDiameterFromHeight$sibbesenReplaceAbatPhysioRelHt = fit_gsl_nls("Sibbesen replace ABA+T RelHt physio", DBH ~ (a1 + a3 * standBasalAreaApprox + a4 * elevation + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016physio, start = list(a1 = 5.0, a3 = -0.014, a4 = -0.001, a9 = -5.3, b1 = 0.53, b2 = 0.22)) # a2, a3, a4 not significant
  umcaDiameterFromHeight$sibbesenReplaceAbatRelHt = fit_gsl_nls("Sibbesen replace ABA+T RelHt", DBH ~ (a1 + a2 * tallerApproxBasalArea + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016, start = list(a1 = 4.4, a2 = -0.025, a9 = -5, b1 = 0.53, b2 = 0.22)) # a2, a9p not significant
  umcaDiameterFromHeight$sibbesenReplacePhysio = fit_gsl_nls("Sibbesen replace physio", DBH ~ (a1 + a4 * elevation)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016physio, start = list(a1 = 3.3, a4 = 0.002, b1 = 0.48, b2 = 0.21), significant = FALSE) # a1p, a4, a5, a6, a7, a8 not significant, step factor with b1p
  umcaDiameterFromHeight$sibbesenReplaceRelHt = fit_gsl_nls("Sibbesen replace RelHt", DBH ~ (a1 + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016, start = list(a1 = 0.496, a9 = -0.188, b1 = 2.31, b2 = -0.12), significant = FALSE) # a9 not significant
  umcaDiameterFromHeight$sibbesenReplaceRelHtPhysio = fit_gsl_nls("Sibbesen replace RelHt physio", DBH ~ (a1 + a4 * elevation + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016physio, start = list(a1 = 4.2, a4 = 0, a9 = -3, b1 = 0.53, b2 = 0.20)) # a4 not significant
  umcaDiameterFromHeight$weibull = fit_gsl_nls("Weibull inverse", DBH ~ (a1*log(1 - pmin(b1*(TotalHt - 1.37), 0.9999)))^b2, umca2016, start = list(a1 = -200, b1 = 0.027, b2 = 0.8), control = gsl_nls_control(maxiter = 500)) # NaN-inf with nlrob()
  #confint_nlrob(umcaDiameterFromHeight$weibull, level = 0.99)
  
  if (umcaOptions$fitDbhNlrob)
  {
    umcaDiameterFromHeightNlrob = list(naslund = fit_nlrob("Näslund inverse", DBH ~ (a1 + a1p * isPlantation) * sqrt(TotalHt - 1.37) / (1 + a2*sqrt(TotalHt - 1.37)), umca2016, start = list(a1 = 3.9, a1p = -1.0, a2 = -0.14)))
    umcaDiameterFromHeightNlrob$power = fit_nlrob("power", DBH ~ (a1 + a1p * isPlantation)*(TotalHt - 1.37)^(b1 + b1p * isPlantation), umca2016, start = list(a1 = 3.28, a1p = -2.10, b1 = 0.917, b1p = 0.332))
    #umcaDiameterFromHeightNlrob$powerAbat = fit_nlrob("power ABA+T", DBH ~ (a1 + a2 * tallerApproxBasalArea)*(TotalHt - 1.37)^(b1 + b1p * isPlantation), umca2016, start = list(a1 = 2.71, a2 = 0.00054, b1 = 0.975, b1p = -0.0696))
    #umcaDiameterFromHeightNlrob$powerPhysio = fit_nlrob("power physio", DBH ~ (a1 + a1p * isPlantation + a4 * elevation + a5 * sin(3.14159/180 * slope) + a6 * cos(3.14159/180 * aspect) + a8 * topographicShelterIndex)*(TotalHt - 1.37)^b1, umca2016physio, start = list(a1 = 4, a1p = -0.95, a4 = 0.002, a5 = -2.8, a6 = 0.4, a8 = 0.05, b1 = 0.94))
    #umcaDiameterFromHeightNlrob$powerRelHt = fit_nlrob("power RelHt", DBH ~ (a1 + a1p * isPlantation + (a9 + a9p * isPlantation) * relativeHeight)*(TotalHt - 1.37)^b1, umca2016, start = list(a1 = 2.37, a1p = -0.887, a9 = -1.508, a9p = 1513, b1 = 1.123))
    umcaDiameterFromHeightNlrob$ruark = fit_nlrob("Ruark", DBH ~ a1*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016, start = list(a1 = 3.95, b1 = 0.45, b2 = 0.06))
    umcaDiameterFromHeightNlrob$ruarkAbat = fit_nlrob("Ruark ABA+T", DBH ~ (a1 + a2 * tallerApproxBasalArea)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016, start = list(a1 = 4.0, a2 = 0, b1 = 0.43, b2 = 0.06), control = nls.control(maxiter = 100, tol = 0.001), significant = FALSE) # job step factor
    umcaDiameterFromHeightNlrob$ruarkAbatPhysio = fit_nlrob("Ruark ABA+T physio", DBH ~ (a1 + a2 * tallerApproxBasalArea + a5 * sin(3.14159/180 * slope))*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016physio, start = list(a1 = 5.5, a2 = -0.001, a5 = -2, b1 = 0.6, b2 = 0.04), control = nls.control(maxiter = 100, tol = 1E-4), significant = FALSE) # job step factor
    umcaDiameterFromHeightNlrob$ruarkAbatPhysioRelHt = fit_nlrob("Ruark ABA+T RelHt physio", DBH ~ (a1 + a2 * tallerApproxBasalArea + a5 * sin(3.14159/180 * slope) + a9 * relativeHeight)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016physio, start = list(a1 = 5.5, a2 = -0.03, a5 = -2, a9 = -5.5, b1 = 0.6, b2 = 0.07), control = nls.control(maxiter = 100, tol = 0.001)) # job step factor
    umcaDiameterFromHeightNlrob$ruarkAbatRelHt = fit_nlrob("Ruark ABA+T RelHt", DBH ~ (a1 + a2 * tallerApproxBasalArea + a9 * relativeHeight)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016, start = list(a1 = 4.6, a2 = -0.03, a9 = -6.2, b1 = 0.44, b2 = 0.11))
    umcaDiameterFromHeightNlrob$ruarkPhysio = fit_nlrob("Ruark physio", DBH ~ (a1 + a5 * sin(3.14159/180 * slope))*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016physio, start = list(a1 = 4.3, a5 = -0.6, b1 = 0.44, b2 = 0.060), control = nls.control(maxiter = 100, tol = 1E-4), significant = FALSE) # job step factor
    umcaDiameterFromHeightNlrob$ruarkRelHt = fit_nlrob("Ruark RelHt", DBH ~ (a1 + a9 * relativeHeight)*(TotalHt - 1.37)^(b1 + b1p * isPlantation) * exp((b2 + b2p * isPlantation) * (TotalHt - 1.37)), umca2016, start = list(a1 = 4, a9 = -2, b1 = 0.7, b1p = -0.5, b2 = 0.04, b2p = 0.08), significant = FALSE)
    umcaDiameterFromHeightNlrob$ruarkRelHtPhysio = fit_nlrob("Ruark RelHt physio", DBH ~ (a1 + a5 * sin(3.14159/180 * slope) + a9 * relativeHeight)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016physio, start = list(a1 = 4.5, a5 = 0, a9 = -5, b1 = 0.45, b2 = 0.09), control = nls.control(maxiter = 100, tol = 1E-4), significant = FALSE) # job step factor
    #umcaDiameterFromHeightNlrob$schnute = fit_nlrob("Schnute inverse", DBH ~ -1/a1 * log(1 - (1 - exp(-a2))*(TotalHt^b1 - 1.37^b1)/(Ha^b1 - 1.3^b1)), umca2016, start = list(a1 = 0.000003, a2 = 0.002, b1 = 1.13, Ha = 177)) # NaN-inf
    umcaDiameterFromHeightNlrob$sibbesenReplace = fit_nlrob("Sibbesen replace", DBH ~ a1*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016, start = list(a1 = 0.43, b1 = 2.45, b2 = -0.15))
    umcaDiameterFromHeightNlrob$sibbesenReplaceAbat = fit_nlrob("Sibbesen replace ABA+T", DBH ~ (a1 + a2 * tallerApproxBasalArea)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016, start = list(a1 = 3.8, a2 = -0.006, b1 = 0.46, b2 = 0.21), control = nls.control(maxiter = 100, tol = 0.001), significant = FALSE) # occasional step factor
    umcaDiameterFromHeightNlrob$sibbesenReplaceAbatPhysio = fit_nlrob("Sibbesen replace ABA+T physio", DBH ~ (a1 + a2 * tallerApproxBasalArea + a4 * elevation)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016physio, start = list(a1 = 4.1, a2 = 0, a4 = 0, b1 = 0.49, b2 = 0.18), significant = FALSE)
    umcaDiameterFromHeightNlrob$sibbesenReplaceAbatPhysioRelHt = fit_nlrob("Sibbesen replace ABA+T RelHt physio", DBH ~ (a1 + a3 * standBasalAreaApprox + a4 * elevation + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016physio, start = list(a1 = 5.1, a3 = -0.015, a4 = -0.001, a9 = -5.3, b1 = 0.53, b2 = 0.22), control = nls.control(maxiter = 100, tol = 1E-4)) # job step factor
    umcaDiameterFromHeightNlrob$sibbesenReplaceAbatRelHt = fit_nlrob("Sibbesen replace ABA+T RelHt", DBH ~ (a1 + a2 * tallerApproxBasalArea + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016, start = list(a1 = 4.4, a2 = -0.032, a9 = -6, b1 = 0.5, b2 = 0.27))
    umcaDiameterFromHeightNlrob$sibbesenReplacePhysio = fit_nlrob("Sibbesen replace physio", DBH ~ (a1 + a4 * elevation)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016physio, start = list(a1 = 3.3, a4 = 0.002, b1 = 0.48, b2 = 0.21), significant = FALSE)
    umcaDiameterFromHeightNlrob$sibbesenReplaceRelHt = fit_nlrob("Sibbesen replace RelHt", DBH ~ (a1 + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016, start = list(a1 = 0.496, a9 = -0.188, b1 = 2.31, b2 = -0.12), significant = FALSE)
    #umcaDiameterFromHeightNlrob$sibbesenReplaceRelHtPhysio = fit_nlrob("Sibbesen replace RelHt physio", DBH ~ (a1 + a4 * elevation + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016physio, maxit = 500, start = list(a1 = 4.2, a4 = 0, a9 = -2.8, b1 = 0.53, b2 = 0.18)) # >500 steps to converge
  } else {
    umcaDiameterFromHeightNlrob = list()
  }
  
  umcaDiameterFromHeightGslNlsDefault = list(chapmanReplace = fit_gsl_nls("Chapman-Richards replace", DBH ~ a1*(exp(b1*(TotalHt - 1.37)) - 1)^b2, umca2016defaultWeight, start = list(a1 = 20, b1 = 0.1, b2 = 0.6), control = gsl_nls_control(maxiter = 250, xtol = 0.002))) # a1-b1 evaporation
  umcaDiameterFromHeightGslNlsDefault$chapmanReplaceAbat = fit_gsl_nls("Chapman-Richards replace ABA+T", DBH ~ (a1 + a2 * tallerApproxBasalArea)*(exp(b1*(TotalHt - 1.37)) - 1)^b2, umca2016defaultWeight, start = list(a1 = 20, a2 = 0, b1 = 0.1, b2 = 0.6), control = gsl_nls_control(maxiter = 250, xtol = 0.005), significant = FALSE) # a1-b1 evaporation
  umcaDiameterFromHeightGslNlsDefault$chapmanReplaceRelHt = fit_gsl_nls("Chapman-Richards replace RelHt", DBH ~ (a1 + a9 * pmin(relativeHeight, 1.5))*(exp(b1*(TotalHt - 1.37)^b2) - 1), umca2016defaultWeight, start = list(a1 = 0.9, a9 = -0.6, b1 = 1.8, b2 = 0.3), control = gsl_nls_control(maxiter = 250, xtol = 0.002)) # a1 and b1 both tend to zero
  umcaDiameterFromHeightGslNlsDefault$chapmanRichards = fit_gsl_nls("Chapman-Richards inverse", DBH ~ a1*log(1 - pmin(b1*(TotalHt - 1.37)^(b2 + b2p * isPlantation), 0.9999)), umca2016defaultWeight, start = list(a1 = 34, b1 = -0.047, b2 = 1.43, b2p = -0.15), control = gsl_nls_control(maxiter = 500, xtol = 0.002))
  umcaDiameterFromHeightGslNlsDefault$chapmanRichardsAbat = fit_gsl_nls("Chapman-Richards inverse ABA+T", DBH ~ (a1 + a2 * tallerApproxBasalArea)*log(1 - pmin(b1*(TotalHt - 1.37)^(b2 + b2p * isPlantation), 0.9999)), umca2016defaultWeight, start = list(a1 = 25, a2 = -1, b1 = -0.01, b2 = 1.5, b2p = -0.2), control = gsl_nls_control(maxiter = 500, xtol = 0.001), significant = FALSE) # susceptible to a1-b1 evaporation
  umcaDiameterFromHeightGslNlsDefault$chapmanRichardsPhysio = fit_gsl_nls("Chapman-Richards inverse physio", DBH ~ (a1 + a5 * sin(3.14159/180 * slope))*log(1 - pmin(b1*(TotalHt - 1.37)^b2, 0.9999)), umca2016defaultWeightPhysio, start = list(a1 = 58.6, a5 = -52.7, b1 = -0.0637, b2 = 0.9), control = gsl_nls_control(maxiter = 500, xtol = 0.001), significant = FALSE) # a1-b1 evaporation
  umcaDiameterFromHeightGslNlsDefault$chapmanRichardsRelHt = fit_gsl_nls("Chapman-Richards inverse RelHt", DBH ~ (a1 + a9 * relativeHeight)*log(1 - pmin(b1*(TotalHt - 1.37)^b2, 0.9999)), umca2016defaultWeight, start = list(a1 = 35, a9 = -15, b1 = -0.03, b2 = 0.9), control = gsl_nls_control(maxiter = 500, xtol = 0.001), significant = FALSE) # a1-b1 evaporation
  umcaDiameterFromHeightGslNlsDefault$michaelisMentenReplace = fit_gsl_nls("Michaelis-Menten replace", DBH ~ a1 * (TotalHt - 1.37)^b1 / (a2 - (TotalHt - 1.37)^b1), umca2016defaultWeight, start = list(a1 = 100, a2 = 100, b1 = 1))
  umcaDiameterFromHeightGslNlsDefault$naslund = fit_gsl_nls("Näslund inverse", DBH ~ (a1 + a1p * isPlantation) * sqrt(TotalHt - 1.37) / (1 + a2*sqrt(TotalHt - 1.37)), umca2016defaultWeight, start = list(a1 = 3.9, a1p = -1.0, a2 = -0.14))
  umcaDiameterFromHeightGslNlsDefault$power = fit_gsl_nls("power", DBH ~ (a1 + a1p * isPlantation)*(TotalHt - 1.37)^(b1 + b1p * isPlantation), umca2016defaultWeight, start = list(a1 = 3.28, a1p = -2.10, b1 = 0.917, b1p = 0.332))
  #umcaDiameterFromHeightGslNlsDefault$powerAbat = fit_gsl_nls("power ABA+T", DBH ~ (a1 + a2 * tallerApproxBasalArea)*(TotalHt - 1.37)^(b1 + b1p * isPlantation), umca2016defaultWeight, start = list(a1 = 2.71, a2 = 0.00054, b1 = 0.975, b1p = -0.0696))
  #umcaDiameterFromHeightGslNlsDefault$powerPhysio = fit_gsl_nls("power physio", DBH ~ (a1 + a1p * isPlantation + a4 * elevation + a5 * sin(3.14159/180 * slope) + a6 * cos(3.14159/180 * aspect) + a8 * topographicShelterIndex)*(TotalHt - 1.37)^b1, umca2016defaultWeightPhysio, start = list(a1 = 4, a1p = -0.95, a4 = 0.002, a5 = -2.8, a6 = 0.4, a8 = 0.05, b1 = 0.94))
  #umcaDiameterFromHeightGslNlsDefault$powerRelHt = fit_gsl_nls("power RelHt", DBH ~ (a1 + a1p * isPlantation + (a9 + a9p * isPlantation) * relativeHeight)*(TotalHt - 1.37)^b1, umca2016defaultWeight, start = list(a1 = 2.37, a1p = -0.887, a9 = -1.508, a9p = 1513, b1 = 1.123))
  umcaDiameterFromHeightGslNlsDefault$ruark = fit_gsl_nls("Ruark", DBH ~ a1*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016defaultWeight, start = list(a1 = 3.95, b1 = 0.45, b2 = 0.06))
  umcaDiameterFromHeightGslNlsDefault$ruarkAbat = fit_gsl_nls("Ruark ABA+T", DBH ~ (a1 + a2 * tallerApproxBasalArea)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016defaultWeight, start = list(a1 = 2.2, a2 = -0.004, b1 = 1.1, b2 = -0.01), significant = FALSE)
  umcaDiameterFromHeightGslNlsDefault$ruarkAbatPhysio = fit_gsl_nls("Ruark ABA+T physio", DBH ~ (a1 + a2 * tallerApproxBasalArea + a5 * sin(3.14159/180 * slope))*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016defaultWeightPhysio, start = list(a1 = 3.6, a2 = 0, a5 = -1.8, b1 = 1.3, b2 = -0.03), significant = FALSE)
  umcaDiameterFromHeightGslNlsDefault$ruarkAbatPhysioRelHt = fit_gsl_nls("Ruark ABA+T RelHt physio", DBH ~ (a1 + a2 * tallerApproxBasalArea + a5 * sin(3.14159/180 * slope) + a9 * relativeHeight)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016defaultWeightPhysio, start = list(a1 = 3.7, a2 = -0.02, a5 = -1.8, a9 = -2.5, b1 = 1.1, b2 = 0))
  umcaDiameterFromHeightGslNlsDefault$ruarkAbatRelHt = fit_gsl_nls("Ruark ABA+T RelHt", DBH ~ (a1 + a2 * tallerApproxBasalArea + a9 * relativeHeight)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016defaultWeight, start = list(a1 = 2.6, a2 = -0.02, a9 = -2.1, b1 = 1.2, b2 = 0.02)) # b2 not significant
  umcaDiameterFromHeightGslNlsDefault$ruarkPhysio = fit_gsl_nls("Ruark physio", DBH ~ (a1 + a5 * sin(3.14159/180 * slope))*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016defaultWeightPhysio, start = list(a1 = 3.3, a5 = -2.0, b1 = 1.0, b2 = 0), significant = FALSE)
  umcaDiameterFromHeightGslNlsDefault$ruarkRelHt = fit_gsl_nls("Ruark RelHt", DBH ~ (a1 + a9 * relativeHeight)*(TotalHt - 1.37)^(b1 + b1p * isPlantation) * exp((b2 + b2p * isPlantation) * (TotalHt - 1.37)), umca2016defaultWeight, start = list(a1 = 4, a9 = -2, b1 = 0.7, b1p = -0.5, b2 = 0.04, b2p = 0.08), significant = FALSE)
  umcaDiameterFromHeightGslNlsDefault$ruarkRelHtPhysio = fit_gsl_nls("Ruark RelHt physio", DBH ~ (a1 + a5 * sin(3.14159/180 * slope) + a9 * relativeHeight)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016defaultWeightPhysio, start = list(a1 = 3.5, a5 = -1.8, a9 = -1.4, b1 = 1.2, b2 = 0), control = nls.control(maxiter = 100, tol = 1E-4), significant = FALSE) # a5, a9, b2 not significant, job step factor
  umcaDiameterFromHeightGslNlsDefault$schnute = fit_gsl_nls("Schnute inverse", DBH ~ -1/a1 * log(1 - (1 - exp(-a2))*(TotalHt^b1 - 1.37^b1)/(Ha^b1 - 1.3^b1)), umca2016defaultWeight, start = list(a1 = 0.000003, a2 = 0.002, b1 = 1.13, Ha = 177))
  #umcaDiameterFromHeightGslNlsDefault$sharmaParton = fit_gsl_nls("modified Sharma-Parton", DBH ~ a1*(TotalHt - 1.37)^b1*(exp(b2*(tph/topHeight)^b3*(TotalHt - 1.37)) - 1)^b4, umca2016defaultWeight, start = list(a1 = 0.18, b1 = 1.15, b2 = 0.00001, b3 = 0.8, b4 = -0.28), control = gsl_nls_control(maxiter = 250, xtol = 0.001))
  umcaDiameterFromHeightGslNlsDefault$sibbesenReplace = fit_gsl_nls("Sibbesen replace", DBH ~ a1*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016defaultWeight, start = list(a1 = 0.43, b1 = 2.45, b2 = -0.15))
  umcaDiameterFromHeightGslNlsDefault$sibbesenReplaceAbat = fit_gsl_nls("Sibbesen replace ABA+T", DBH ~ (a1 + a2 * tallerApproxBasalArea)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016defaultWeight, start = list(a1 = 1.8, a2 = -0.002, b1 = 1.8, b2 = -0.1))
  umcaDiameterFromHeightGslNlsDefault$sibbesenReplaceAbatPhysio = fit_gsl_nls("Sibbesen replace ABA+T physio", DBH ~ (a1 + a2 * tallerApproxBasalArea + a4 * elevation)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016defaultWeightPhysio, start = list(a1 = 1.8, a2 = 0, a4 = 0, b1 = 1.3, b2 = 0), significant = FALSE)
  umcaDiameterFromHeightGslNlsDefault$sibbesenReplaceAbatPhysioRelHt = fit_gsl_nls("Sibbesen replace ABA+T RelHt physio", DBH ~ (a1 + a3 * standBasalAreaApprox + a4 * elevation + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016defaultWeightPhysio, start = list(a1 = 3.3, a3 = -0.01, a4 = -0.001, a9 = -2.6, b1 = 1.0, b2 = 0.07))
  umcaDiameterFromHeightGslNlsDefault$sibbesenReplaceAbatRelHt = fit_gsl_nls("Sibbesen replace ABA+T RelHt", DBH ~ (a1 + a2 * tallerApproxBasalArea + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016defaultWeight, start = list(a1 = 2.8, a2 = -0.015, a9 = -3, b1 = 1.1, b2 = 0.15)) # b2 not significant
  umcaDiameterFromHeightGslNlsDefault$sibbesenReplacePhysio = fit_gsl_nls("Sibbesen replace physio", DBH ~ (a1 + a4 * elevation)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016defaultWeightPhysio, start = list(a1 = 3.3, a4 = 0.002, b1 = 0.48, b2 = 0.21), significant = FALSE)
  umcaDiameterFromHeightGslNlsDefault$sibbesenReplaceRelHt = fit_gsl_nls("Sibbesen replace RelHt", DBH ~ (a1 + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016defaultWeight, start = list(a1 = 0.496, a9 = -0.188, b1 = 2.31, b2 = -0.12), significant = FALSE)
  umcaDiameterFromHeightGslNlsDefault$sibbesenReplaceRelHtPhysio = fit_gsl_nls("Sibbesen replace RelHt physio", DBH ~ (a1 + a4 * elevation + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016defaultWeightPhysio, start = list(a1 = 4.2, a4 = 0, a9 = -2.8, b1 = 0.53, b2 = 0.18)) # a4 not significant
  umcaDiameterFromHeightGslNlsDefault$weibull = fit_gsl_nls("Weibull inverse", DBH ~ (a1*log(1 - pmin(b1*(TotalHt - 1.37), 0.9999)))^b2, umca2016defaultWeight, start = list(a1 = -200, b1 = 0.027, b2 = 0.8), control = gsl_nls_control(maxiter = 500))
  
  umcaDiameterFromHeight$gam = fit_gam("REML GAM", DBH ~ s(TotalHt, bs = "ts", by = as.factor(isPlantation), k = 9, pc = gamConstraint), data = umca2016, constraint = umca2016gamConstraint)
  umcaDiameterFromHeight$gamAbat = fit_gam("REML GAM ABA+T", DBH ~ s(TotalHt, tallerApproxBasalArea, standBasalAreaApprox, bs = "ts", by = as.factor(isPlantation), k = 14, pc = gamConstraint), data = umca2016, constraint = umca2016gamConstraint)
  umcaDiameterFromHeight$gamAbatPhysio = fit_gam("REML GAM ABA+T physio", DBH ~ s(TotalHt, standBasalAreaApprox, tallerApproxBasalArea, slope, bs = "ts", by = as.factor(isPlantation), k = 28, pc = gamConstraint), data = umca2016physio, constraint = umca2016gamConstraint) # >5 minute Zen 3 3.4 GHz fit time with ABA+T, elevation, slope, sin(aspect), and TSI: elevation dropped based on physio AICs, then TSI+aspect
  umcaDiameterFromHeight$gamAbatPhysioRelHt = fit_gam("REML GAM ABA+T RelHt physio", DBH ~ s(TotalHt, tallerApproxBasalArea, slope, sin(3.14159/180 * aspect), relativeHeight, bs = "ts", by = as.factor(isPlantation), k = 57, pc = gamConstraint), data = umca2016physio, constraint = umca2016gamConstraint) # insufficient data -> drop elevation and ABA
  umcaDiameterFromHeight$gamPhysio = fit_gam("REML GAM physio", DBH ~ s(TotalHt, elevation, slope, sin(3.14159/180 * aspect), topographicShelterIndex, bs = "ts", by = as.factor(isPlantation), k = 60, pc = gamConstraint), data = umca2016physio, constraint = umca2016gamConstraint) # 72.5% deviance explained (AIC 6089): 75.7% (5995) without elevation, 71.3% (6111) without slope, 72.4% (6043) without aspect, 72.7% (6034) without topographic shelter
  umcaDiameterFromHeight$gamRelHt = fit_gam("REML GAM RelHt", DBH ~ s(TotalHt, relativeHeight, bs = "ts", by = as.factor(isPlantation), k = 10, pc = gamConstraint), data = umca2016, constraint = umca2016gamConstraint)
  umcaDiameterFromHeight$gamRelHtPhysio = fit_gam("REML GAM RelHt physio", DBH ~ s(TotalHt, slope, sin(3.14159/180 * aspect), relativeHeight, bs = "ts", by = as.factor(isPlantation), k = 57, pc = gamConstraint), data = umca2016physio, constraint = umca2016gamConstraint) # drop elevation on AIC
  
  save(file = "trees/height-diameter/data/UMCA DBH.Rdata", umcaDiameterFromHeight, umcaDiameterFromHeightNlrob, umcaDiameterFromHeightGslNlsDefault)
}
if (htDiaOptions$includeInvestigatory)
{
  print(umcaDiameterFromHeightResults %>% select(-responseVariable, -species, -biasNR, -biasPl, -rmse, -rmseNR, -rmsePl, -pearsonNR, -pearsonPl, -aic, -bic), n = 25)

  ggplot(umca2016) +
    geom_point(aes(x = DBH, y = TotalHt), alpha = 0.10, color = "grey25", shape = 16) +
    #geom_line(aes(x = predict(umcaDiameterFromHeight$chapmanReplace), y = TotalHt, color = "Chapman-Richards replace", group = isPlantation)) +
    #geom_line(aes(x = predict(umcaDiameterFromHeight$chapmanReplaceAbat), y = TotalHt, color = "Chapman-Richards replace approximate BA+L", group = isPlantation), alpha = 0.5) +
    #geom_line(aes(x = predict(umcaDiameterFromHeight$chapmanReplaceBal), y = TotalHt, color = "Chapman-Richards replace BA+L", group = isPlantation), alpha = 0.5) +
    #geom_line(aes(x = predict(umcaDiameterFromHeight$chapmanRichards), y = TotalHt, color = "Chapman-Richards", group = isPlantation)) +
    #geom_line(aes(x = predict(umcaDiameterFromHeight$michaelisMentenReplace), y = TotalHt, color = "Michaelis-Menten replace", group = isPlantation)) +
    #geom_line(aes(x = predict(umcaDiameterFromHeight$naslund), y = TotalHt, color = "Näslund", group = isPlantation)) +
    #geom_line(aes(x = predict(umcaDiameterFromHeight$power), y = TotalHt, color = "power", group = isPlantation)) +
    #geom_line(aes(x = predict(umcaDiameterFromHeight$ruark), y = TotalHt, color = "Ruark", group = isPlantation)) +
    #geom_line(aes(x = predict(umcaDiameterFromHeight$schnute), y = TotalHt, color = "Schnute inverse", group = isPlantation)) +
    #geom_line(aes(x = predict(umcaDiameterFromHeight$sharmaParton), y = TotalHt, color = "modified Sharma-Parton", group = isPlantation), alpha = 0.5) +
    #geom_line(aes(x = predict(umcaDiameterFromHeight$sibbesenReplace), y = TotalHt, color = "Sibbesen replace", group = isPlantation)) +
    #geom_line(aes(x = predict(umcaDiameterFromHeight$weibull), y = TotalHt, color = "Weibull", group = isPlantation)) +
    #geom_line(aes(x = -70 * log(1 - pmin(0.01*(TotalHt - 1.37)^1.1, 0.999)), y = TotalHt, color = "Chapman-Richards"), na.rm = TRUE) +
    #geom_line(aes(x = 15 * (exp(0.1*(TotalHt - 1.37)) - 1)^0.5, y = TotalHt, color = "Chapman replace", group = isPlantation), alpha = 0.5) +
    geom_line(aes(x = 1*(TotalHt - 1.37)^1*exp(0.02*(tph/topHeight)^0.4*(TotalHt - 1.37))^0.9, y = TotalHt, color = "modified Sharma-Parton", group = isPlantation), alpha = 0.5) +
    #geom_line(aes(x = 15 * (exp(0.12*(TotalHt - 1.37)) - 1)^0.5, y = TotalHt, color = "Chapman-Richards", group = isPlantation), alpha = 0.5) +
    #geom_line(aes(x = (1.75 + 0.000001 * tallerApproxBasalArea + -0.000001 * standBasalAreaApprox) * exp(1.46*(TotalHt - 1.37)^0.280), y = TotalHt, color = "Chapman-Richards replace ABA+T", group = isPlantation), alpha = 0.5) +
    #geom_line(aes(x = 0.03*topHeight*exp(1.6*(TotalHt - 1.37)^0.26), y = TotalHt, color = "Chapman-Richards replace top height", group = isPlantation), alpha = 0.5) +
    #geom_line(aes(x = 1*(TotalHt - 1.37)^1.5, y = TotalHt, color = "power"), alpha = 0.5) +
    #geom_line(aes(x = 1*(TotalHt - 1.37)^1.5*(1 - exp(-0.01 * (tph/standBasalAreaPerHectare)^1*(TotalHt - 1.37)))^1, y = TotalHt, color = "Sharma-Parton"), alpha = 0.5) +
    #geom_line(aes(x = 5*standBasalAreaPerHectare^0.5 * exp(0.0005*tph^0.5*(TotalHt - 1.37))^1, y = TotalHt, color = "Sharma-Zhang"), alpha = 0.5) +
    #annotate("text", x = 0, y = 37, label = "Oregon myrtle, diameter from height", hjust = 0, size = 3.5) +
    #coord_cartesian(xlim = c(0, 250), ylim = c(0, 90)) +
    labs(x = "DBH, cm", y = "height, m", color = NULL) +
    #scale_color_manual(breaks = c(FALSE, TRUE, "Chapman-Richards"), values = c("grey25", "transparent", "red")) +
    #scale_color_manual(breaks = c(FALSE, TRUE, "Chapman-Richards"), values = c("transparent", "grey25", "red")) +
    scale_y_continuous(breaks = seq(0, 100, by = 20)) +
    theme(legend.justification = c(1, 0), legend.position = c(0.99, 0.03))
}

if (umcaOptions$fitDbhMixed)
{
  #umcaDiameterFromHeightMixed = list(chapmanReplace = fit_nlme("Chapman-Richards replace", DBH ~ (a1 + a1r)*(exp(b1*(TotalHt - 1.37)) - 1)^b2, umca2016, 
  #                                                             fixedFormula = a1 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
  #                                                             start = list(fixed = c(a1 = 20, b1 = 0.1, b2 = 0.6))), control = nlmeControl(tolerance = 0.01, pnlsTol = 1, msTol = 1E-3)) # singularity in backsolve
  #umcaDiameterFromHeightMixed = list(chapmanReplaceAbat = fit_nlme("Chapman-Richards replace ABA+T", DBH ~ (a1 + a1r + a2 * tallerApproxBasalArea)*(exp(b1*(TotalHt - 1.37)) - 1)^b2, umca2016,
  #                                                                 fixedFormula = a1 + a2 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
  #                                                                 start = list(fixed = c(a1 = 18, a2 = 0, b1 = 0.1, b2 = 0.6)), control = nlmeControl(maxIter = 100, tolerance = 0.01, pnlsTol = 1, msTol = 0.001), significant = FALSE)) # singularity in backsolve
  #umcaDiameterFromHeightMixed$chapmanReplaceBal = fit_nlme("Chapman-Richards replace BA+L", DBH ~ (a1 + a1r + a2 * basalAreaLarger) * (exp(b1*(TotalHt - 1.37)^b2) - 1), umca2016, 
  #                                                         fixedFormula = a1 + a2 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
  #                                                         start = list(fixed = c(a1 = 1, a2 = -0.005, b1 = 1.9, b2 = 0.3)), control = nlmeControl(tolerance = 0.01, pnlsTol = 1, msTol = 0.001)) # step halving
  #umcaDiameterFromHeightMixed$chapmanReplaceBalRelHt = fit_nlme("Chapman-Richards replace BA+L RelHt", DBH ~ (a1 + a1r + a2 * basalAreaLarger + a3 * standBasalAreaPerHectare + a9 * relativeHeight) * (exp(b1*(TotalHt - 1.37)^b2) - 1), umca2016, 
  #                                                              fixedFormula = a1 + a2 + a3 + a9 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
  #                                                              start = list(fixed = c(a1 = 0.4, a2 = -0.012, a3 = 0.01, a9 = -0.3, b1 = 2.7, b2 = 0.23)), control = nlmeControl(tolerance = 0.01, pnlsTol = 1, msTol = 1E-3)) # step halving
  #umcaDiameterFromHeightMixed$chapmanReplaceRelHt = fit_nlme("Chapman-Richards replace RelHt", DBH ~ (a1 + a1r + a9 * pmin(relativeHeight, 1.5))*(exp(b1*(TotalHt - 1.37)^b2) - 1), umca2016, 
  #                                                           fixedFormula = a1 + a9 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
  #                                                           start = list(fixed = c(a1 = 0.9, a9 = -0.6, b1 = 1.8, b2 = 0.3)), control = nlmeControl(tolerance = 0.01, pnlsTol = 1, msTol = 0.001))
  #umcaDiameterFromHeightMixed = list(chapmanRichards = fit_nlme("Chapman-Richards inverse", DBH ~ (a1 + a1r)*log(1 - pmin(b1*(TotalHt - 1.37)^(b2 + b2p * isPlantation), 0.9999)), umca2016, 
  #                                                              fixedFormula = a1 + b1 + b2 + b2p ~ 1, randomFormula = a1r ~ 1, 
  #                                                              start = list(fixed = c(a1 = 34, b1 = -0.047, b2 = 1.43, b2p = -0.15)), control = nlmeControl(maxiter = 250, tolerance = 0.01, pnlsTol = 1, msTol = 0.001))) # step halving
  #umcaDiameterFromHeightMixed$chapmanRichardsAbat = fit_nlme("Chapman-Richards inverse ABA+T", DBH ~ (a1 + a1r + a2 * tallerApproxBasalArea)*log(1 - pmin(b1*(TotalHt - 1.37)^(b2 + b2p * isPlantation), 0.9999)), umca2016, 
  #                                                           fixedFormula = a1 + a2 + b1 + b2 + b2p ~ 1, randomFormula = a1r ~ 1, 
  #                                                           start = list(fixed = c(a1 = 35, a2 = -3, b1 = -0.01, b2 = 0.9, b2p = -0.2)), control = nlmeControl(maxiter = 250, tolerance = 0.01, pnlsTol = 1, msTol = 0.001), significant = FALSE) # singularity in backsolve
  #umcaDiameterFromHeightMixed$chapmanRichardsPhysio = fit_nlme("Chapman-Richards inverse physio", DBH ~ (a1 + a1r + a5 * sin(3.14159/180 * slope))*log(1 - pmin(b1*(TotalHt - 1.37)^b2, 0.9999)), umca2016physio, 
  #                                                             fixedFormula = a1 + a5 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
  #                                                             start = list(fixed = c(a1 = 58.6, a5 = -52.7, b1 = -0.0637, b2 = 0.9)), control = nlmeControl(maxiter = 250, tolerance = 0.01, pnlsTol = 1, msTol = 0.001), significant = FALSE) # singular precision, singularity in backsolve
  #umcaDiameterFromHeightMixed$chapmanRichardsRelHt = fit_nlme("Chapman-Richards inverse RelHt", DBH ~ (a1 + a1r + a9 * relativeHeight)*log(1 - pmin(b1*(TotalHt - 1.37)^b2, 0.9999)), umca2016, 
  #                                                            fixedFormula = a1 + a9 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
  #                                                            start = list(fixed = c(a1 = 35, a9 = -15, b1 = -0.03, b2 = 0.9)), control = nlmeControl(maxiter = 250, tolerance = 0.01, pnlsTol = 1, msTol = 0.001), significant = FALSE) # step halving
  #umcaDiameterFromHeightMixed$michaelisMentenReplace = fit_nlme("Michaelis-Menten replace", DBH ~ (a1 + a1r) * (TotalHt - 1.37)^b1 / (a2 - (TotalHt - 1.37)^b1), umca2016, 
  #                                                              fixedFormula = a1 + a2 + b1 ~ 1, randomFormula = a1r ~ 1, 
  #                                                              start = list(fixed = c(a1 = 100, a2 = 100, b1 = 1)), control = nlmeControl(tolerance = 0.01, pnlsTol = 1, msTol = 0.001)) # step halving, job step halving
  umcaDiameterFromHeightMixed = list(naslund = fit_nlme("Näslund inverse", DBH ~ (a1 + a1r + a1p * isPlantation) * sqrt(TotalHt - 1.37) / (1 + a2*sqrt(TotalHt - 1.37)), umca2016,
                                                        fixedFormula = a1 + a1p + a2 ~ 1, randomFormula = a1r ~ 1, 
                                                       start = list(fixed = c(a1 = 3.9, a1p = -1.0, a2 = -0.14))))
  umcaDiameterFromHeightMixed$power = fit_nlme("power", DBH ~ (a1 + a1r + a1p * isPlantation)*(TotalHt - 1.37)^(b1 + b1p * isPlantation), umca2016, 
                                               fixedFormula = a1 + a1p + b1 + b1p ~ 1, randomFormula = a1r ~ 1, 
                                               start = list(fixed = c(a1 = 3.28, a1p = -2.10, b1 = 0.917, b1p = 0.332)), control = nlmeControl(maxIter = 500, tolerance = 0.01, pnlsTol = 1, msTol = 0.001)) # job max iterations
  #umcaDiameterFromHeightMixed$powerAbat = fit_nlme("power ABA+T", DBH ~ (a1 + a1r + a2 * tallerApproxBasalArea)*(TotalHt - 1.37)^(b1 + b1p * isPlantation), umca2016,
  #                                                 fixedFormula = a1 + a2 + b1 + b1p ~ 1, randomFormula = a1r ~ 1, 
  #                                                 start = list(fixed = c(a1 = 2.71, a2 = 0.00054, b1 = 0.975, b1p = -0.0696)))
  #umcaDiameterFromHeightMixed$powerPhysio = fit_nlme("power physio", DBH ~ (a1 + a1r + a1p * isPlantation + a4 * elevation + a5 * sin(3.14159/180 * slope) + a6 * cos(3.14159/180 * aspect) + a8 * topographicShelterIndex)*(TotalHt - 1.37)^b1, umca2016physio, 
  #                                                   fixedFormula = a1 + a1p + a4 + a5 + a6 + a8 + b1 ~ 1, randomFormula = a1r ~ 1, 
  #                                                   start = list(fixed = c(a1 = 4, a1p = -0.95, a4 = 0.002, a5 = -2.8, a6 = 0.4, a8 = 0.05, b1 = 0.94)))
  #umcaDiameterFromHeightMixed$powerRelHt = fit_nlme("power RelHt", DBH ~ (a1 + a1r + a1p * isPlantation + (a9 + a9p * isPlantation) * relativeHeight)*(TotalHt - 1.37)^b1, umca2016, 
  #                                                  fixedFormula = a1 + a1p + a9 + a9p + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
  #                                                  start = list(fixed = c(a1 = 2.37, a1p = -0.887, a9 = -1.508, a9p = 1513, b1 = 1.123)))
  umcaDiameterFromHeightMixed$ruark = fit_nlme("Ruark", DBH ~ (a1 + a1r)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016, 
                                               fixedFormula = a1 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
                                               start = list(fixed = c(a1 = 3.95, b1 = 0.45, b2 = 0.06)), control = nlmeControl(maxIter = 500, tolerance = 0.01, pnlsTol = 1, msTol = 0.001)) # job step halving
  umcaDiameterFromHeightMixed$ruarkAbat = fit_nlme("Ruark ABA+T", DBH ~ (a1 + a1r + a2 * tallerApproxBasalArea)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016, 
                                                   fixedFormula = a1 + a2 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
                                                   start = list(fixed = c(a1 = 4.0, a2 = 0, b1 = 0.55, b2 = 0.045)), control = nlmeControl(maxIter = 500, tolerance = 0.01, pnlsTol = 1, msTol = 0.001), significant = FALSE) # job max iterations
  umcaDiameterFromHeightMixed$ruarkAbatPhysio = fit_nlme("Ruark ABA+T physio", DBH ~ (a1 + a1r + a2 * tallerApproxBasalArea + a5 * sin(3.14159/180 * slope))*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016physio, 
                                                         fixedFormula = a1 + a2 + a5 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
                                                         start = list(fixed = c(a1 = 5.5, a2 = 0, a5 = -1, b1 = 0.5, b2 = 0.04)), control = nlmeControl(maxIter = 250), significant = FALSE)
  umcaDiameterFromHeightMixed$ruarkAbatPhysioRelHt = fit_nlme("Ruark ABA+T RelHt physio", DBH ~ (a1 + a1r + a2 * tallerApproxBasalArea + a5 * sin(3.14159/180 * slope) + a9 * relativeHeight)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016physio, 
                                                              fixedFormula = a1 + a2 + a5 + a9 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
                                                              start = list(fixed = c(a1 = 5.5, a2 = -0.02, a5 = 0, a9 = -4, b1 = 0.6, b2 = 0.07)), control = nlmeControl(maxIter = 500))
  umcaDiameterFromHeightMixed$ruarkAbatRelHt = fit_nlme("Ruark ABA+T RelHt", DBH ~ (a1 + a1r + a2 * tallerApproxBasalArea + a9 * relativeHeight)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016, 
                                                        fixedFormula = a1 + a2 + a9 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
                                                        start = list(fixed = c(a1 = 4.7, a2 = -0.03, a9 = -5.5, b1 = 0.55, b2 = 0.079)))
  umcaDiameterFromHeightMixed$ruarkPhysio = fit_nlme("Ruark physio", DBH ~ (a1 + a1r + a5 * sin(3.14159/180 * slope))*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016physio, 
                                                     fixedFormula = a1 + a5 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
                                                     start = list(fixed = c(a1 = 6, a5 = 0, b1 = 0.6, b2 = 0.04)), control = nlmeControl(maxIter = 500, tolerance = 1E-4, pnlsTol = 0.01, msTol = 1E-5), significant = FALSE) # job max iterations
  umcaDiameterFromHeightMixed$ruarkRelHt = fit_nlme("Ruark RelHt", DBH ~ (a1 + a1r + a9 * relativeHeight)*(TotalHt - 1.37)^(b1 + b1p * isPlantation) * exp((b2 + b2p * isPlantation) * (TotalHt - 1.37)), umca2016, 
                                                    fixedFormula = a1 + a9 + b1 + b1p + b2 + b2p ~ 1, randomFormula = a1r ~ 1,
                                                    start = list(fixed = c(a1 = 4, a9 = -2, b1 = 0.7, b1p = -0.5, b2 = 0.04, b2p = 0.08)), control = nlmeControl(maxIter = 500, tolerance = 0.001, pnlsTol = 0.1, msTol = 1E-4), significant = FALSE) # job max iterations
  umcaDiameterFromHeightMixed$ruarkRelHtPhysio = fit_nlme("Ruark RelHt physio", DBH ~ (a1 + a1r + a5 * sin(3.14159/180 * slope) + a9 * relativeHeight)*(TotalHt - 1.37)^b1 * exp(b2 * (TotalHt - 1.37)), umca2016physio, 
                                                          fixedFormula = a1 + a5 + a9 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
                                                          start = list(fixed = c(a1 = 6, a5 = -2, a9 = -2, b1 = 0.6, b2 = 0.05)))
  #umcaDiameterFromHeightMixed$schnute = fit_nlme("Schnute inverse", DBH ~ -1/a1 * log(1 - (1 - exp(-a2))*(TotalHt^b1 - 1.37^b1)/((Ha + Har)^b1 - 1.3^b1)), umca2016, 
  #                                               fixedFormula = a1 + a2 + b1 + Ha ~ 1, randomFormula = Har ~ 1, 
  #                                               start = list(fixed = c(a1 = 0.000003, a2 = 0.002, b1 = 1.13, Ha = 177)), control = nlmeControl(tolerance = 0.01, pnlsTol = 1, msTol = 0.001)) # singularity in backsolve
  #umcaDiameterFromHeightMixed$sharmaParton = fit_nlme("modified Sharma-Parton", DBH ~ (a1 + a1r)*(TotalHt - 1.37)^b1*(exp(b2*(tph/topHeight)^b3*(TotalHt - 1.37)) - 1)^b4, umca2016, 
  #                                                    fixedFormula = a1 + b1 + b2 + b3 + b4 ~ 1, randomFormula = a1r ~ 1, 
  #                                                    start = list(fixed = c(a1 = 0.2, b1 = 1.05, b2 = 0.000003, b3 = 0.9, b4 = -0.3)), control = nlmeControl(maxiter = 250, tolerance = 0.01, pnlsTol = 1, msTol = 0.001)) # step halving, false convergence
  umcaDiameterFromHeightMixed$sibbesenReplace = fit_nlme("Sibbesen replace", DBH ~ (a1 + a1r)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016, 
                                                         fixedFormula = a1 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
                                                         start = list(fixed = c(a1 = 0.43, b1 = 2.45, b2 = -0.15)))
  umcaDiameterFromHeightMixed$sibbesenReplaceAbat = fit_nlme("Sibbesen replace ABA+T", DBH ~ (a1 + a1r + a2 * tallerApproxBasalArea)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016, 
                                                             fixedFormula = a1 + a2 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
                                                             start = list(fixed = c(a1 = 4.0, a2 = 0, b1 = 0.5, b2 = 0.18)), significant = FALSE)
  umcaDiameterFromHeightMixed$sibbesenReplaceAbatPhysio = fit_nlme("Sibbesen replace ABA+T physio", DBH ~ (a1 + a1r + a2 * tallerApproxBasalArea + a4 * elevation)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016physio, 
                                                                   fixedFormula = a1 + a2 + a4 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
                                                                   start = list(fixed = c(a1 = 4.1, a2 = 0, a4 = 0, b1 = 0.49, b2 = 0.19)), control = nlmeControl(tolerance = 1E-4, pnlsTol = 0.01, msTol = 1E-5), significant = FALSE) # step halving
  umcaDiameterFromHeightMixed$sibbesenReplaceAbatPhysioRelHt = fit_nlme("Sibbesen replace ABA+T RelHt physio", DBH ~ (a1 + a1r + a3 * standBasalAreaApprox + a4 * elevation + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016physio, 
                                                                        fixedFormula = a1 + a3 + a4 + a9 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
                                                                        start = list(fixed = c(a1 = 5.0, a3 = -0.014, a4 = -0.001, a9 = -5.3, b1 = 0.53, b2 = 0.22)))
  umcaDiameterFromHeightMixed$sibbesenReplaceAbatRelHt = fit_nlme("Sibbesen replace ABA+T RelHt", DBH ~ (a1 + a1r + a2 * tallerApproxBasalArea + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016, 
                                                                  fixedFormula = a1 + a2 + a9 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
                                                                  start = list(fixed = c(a1 = 4.4, a2 = -0.025, a9 = -5, b1 = 0.53, b2 = 0.22)))
  umcaDiameterFromHeightMixed$sibbesenReplacePhysio = fit_nlme("Sibbesen replace physio", DBH ~ (a1 + a1r + a4 * elevation)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016physio, 
                                                               fixedFormula = a1 + a4 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
                                                               start = list(fixed = c(a1 = 3.3, a4 = 0.002, b1 = 0.48, b2 = 0.21)), significant = FALSE)
  umcaDiameterFromHeightMixed$sibbesenReplaceRelHt = fit_nlme("Sibbesen replace RelHt", DBH ~ (a1 + a1r + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016, 
                                                              fixedFormula = a1 + a9 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
                                                              start = list(fixed = c(a1 = 0.496, a9 = -0.188, b1 = 2.31, b2 = -0.12)), significant = FALSE)
  umcaDiameterFromHeightMixed$sibbesenReplaceRelHtPhysio = fit_nlme("Sibbesen replace RelHt physio", DBH ~ (a1 + a1r + a4 * elevation + a9 * relativeHeight)*(TotalHt - 1.37)^(b1*(TotalHt - 1.37)^b2), umca2016physio, 
                                                                    fixedFormula = a1 + a4 + a9 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
                                                                    start = list(fixed = c(a1 = 4.2, a4 = 0, a9 = -3, b1 = 0.53, b2 = 0.20)))
  #umcaDiameterFromHeightMixed$weibull = fit_nlme("Weibull inverse", DBH ~ ((a1 + a1r)*log(1 - pmin(b1*(TotalHt - 1.37), 0.9999)))^b2, umca2016, 
  #                                               fixedFormula = a1 + b1 + b2 ~ 1, randomFormula = a1r ~ 1, 
  #                                               start = list(fixed = c(a1 = -200, b1 = 0.027, b2 = 0.8)), control = nlmeControl(maxiter = 500, tolerance = 0.01, pnlsTol = 1, msTol = 0.001)) # singularity in backsolve
  
  umcaDiameterFromHeightMixed$gamm = fit_gam("REML GAM", DBH ~ s(TotalHt, bs = "ts", by = as.factor(isPlantation), k = 9) + s(StandID, bs = "re"), data = umca2016, mixed = TRUE)
  umcaDiameterFromHeightMixed$gammAbat = fit_gam("REML GAM ABA+T", DBH ~ s(TotalHt, tallerApproxBasalArea, standBasalAreaApprox, bs = "ts", by = as.factor(isPlantation), k = 14) + s(StandID, bs = "re"), data = umca2016, mixed = TRUE)
  umcaDiameterFromHeightMixed$gammRelHt = fit_gam("REML GAM RelHt", DBH ~ s(TotalHt, relativeHeight, bs = "ts", by = as.factor(isPlantation), k = 10) + s(StandID, bs = "re"), data = umca2016, mixed = TRUE)
  
  save(file = "trees/height-diameter/data/UMCA DBH mixed.Rdata", umcaDiameterFromHeightMixed)
}


## collect model parameters
if (umcaOptions$fitHeight & umcaOptions$fitHeightMixed & umcaOptions$fitDbh & umcaOptions$fitDbhMixed)
{
  if (exists("umcaHeightFromDiameter") == FALSE) { load("trees/height-diameter/data/UMCA TotalHt.Rdata") }
  #if (exists("umcaHeightFromDiameterGnls") == FALSE) { load("trees/height-diameter/data/UMCA TotalHt GNLS.Rdata") }
  if (exists("umcaHeightFromDiameterMixed") == FALSE) { load("trees/height-diameter/data/UMCA TotalHt mixed.Rdata") }
  if (exists("umcaDiameterFromHeight") == FALSE) { load("trees/height-diameter/data/UMCA DBH.Rdata") }
  if (exists("umcaDiameterFromHeightMixed") == FALSE) { load("trees/height-diameter/data/UMCA DBH mixed.Rdata") }
  
  umcaCoefficients = bind_rows(bind_rows(bind_rows(lapply(umcaHeightFromDiameter, get_list_coefficients)),
                                         #bind_rows(lapply(umcaHeightFromDiameterGnls, get_model_coefficients)),
                                         bind_rows(lapply(umcaHeightFromDiameterGslNlsDefault, get_list_coefficients, fitSet = "gsl_nls", fixedWeight = -1)),
                                         bind_rows(lapply(umcaHeightFromDiameterMixed, get_list_coefficients, fitSet = "mixed")),
                                         bind_rows(lapply(umcaHeightFromDiameterNlrob, get_list_coefficients, fitSet = "nlrob"))) %>%
                                 mutate(responseVariable = "height"),
                               bind_rows(bind_rows(lapply(umcaDiameterFromHeight, get_list_coefficients)),
                                         bind_rows(lapply(umcaDiameterFromHeightGslNlsDefault, get_list_coefficients, fitSet = "gsl_nls", fixedWeight = -1)),
                                         bind_rows(lapply(umcaDiameterFromHeightMixed, get_list_coefficients, fitSet = "mixed")),
                                         bind_rows(lapply(umcaDiameterFromHeightNlrob, get_list_coefficients, fitSet = "nlrob"))) %>%
                                 mutate(responseVariable = "DBH")) %>%
    mutate(species = "UMCA")
  umcaResults = bind_rows(bind_rows(bind_rows(lapply(umcaHeightFromDiameter, get_list_stats)),
                                    bind_rows(lapply(umcaHeightFromDiameterGslNlsDefault, get_list_stats, fitSet = "gsl_nls", fixedWeight = -1)),
                                    bind_rows(lapply(umcaHeightFromDiameterMixed, get_list_stats, fitSet = "mixed")),
                                    bind_rows(lapply(umcaHeightFromDiameterNlrob, get_list_stats, fitSet = "nlrob"))) %>%
                                    #bind_rows(lapply(umcaHeightFromDiameterGnls, get_model_stats))) %>%
                            mutate(responseVariable = "height"),
                          bind_rows(bind_rows(lapply(umcaDiameterFromHeight, get_list_stats)),
                                    create_model_stats(name = "modified Sharma-Parton", fitSet = "primary", fittingMethod = "gsl_nls"),
                                    bind_rows(lapply(umcaDiameterFromHeightGslNlsDefault, get_list_stats, fitSet = "gsl_nls", fixedWeight = -1)),
                                    bind_rows(lapply(umcaDiameterFromHeightMixed, get_list_stats, fitSet = "mixed")),
                                    bind_rows(lapply(umcaDiameterFromHeightNlrob, get_list_stats, fitSet = "nlrob"))) %>%
                            mutate(responseVariable = "DBH")) %>%
    mutate(species = "UMCA")

  check_plot_results(umcaResults)
  save(file = "trees/height-diameter/data/UMCA results.Rdata", umcaCoefficients, umcaResults)
}


## preferred forms identified (results.R, Figure 7)
# Oregon myrtle     Prodan            Chapman-Richards physio        REML GAM                Chapman-Richards physio
#                   Sibbesen          Chapman-Richards BA+L physio   power                   Sibbesen form Physio
#                   REML GAM                                         parabolic
if (umcaOptions$fitHeight & umcaOptions$fitDbh)
{
  umcaHeightFromDiameterPreferred = list(hossfeld = fit_gsl_nls("Hossfeld IV", TotalHt ~ 1.37 + (a1 + a1p * isPlantation) / (1 + (b1 + b1p * isPlantation) *DBH^b2), umca2016, start = list(a1 = 21.4, a1p = -4.37, b1 = 43.8, b1p = -19.9, b2 = -1.27), folds = 1, repetitions = 1))
  umcaHeightFromDiameterPreferred$prodan = fit_gsl_nls("Prodan", TotalHt ~ 1.37 + DBH^2 / ((a1 + a1p * isPlantation) * DBH^2 + (a2 + a2p * isPlantation)*DBH + a3), umca2016, start = list(a1 = 0.040, a1p = 0.017, a2 = 1.01, a2p = -0.40, a3 = 1.46), folds = 1, repetitions = 1)
  umcaHeightFromDiameterPreferred$michaelisMenten = fit_gsl_nls("Michaelis-Menten", TotalHt ~ 1.37 + (a1 + a1p*isPlantation)*DBH^b1 / (a2 + a2p * isPlantation + DBH^b1), umca2016, start = list(a1 = 21.4, a1p = -4.37, a2 = 43.8, a2p = -20.0, b1 = 1.27), folds = 1, repetitions = 1)
  umcaHeightFromDiameterPreferred$sharmaPartonPhysio = fit_gsl_nls("Sharma-Parton physio", TotalHt ~ 1.37 + (a1 + a4 * elevation)*topHeight^b1 * (1 - exp(b2*(tph/(standBasalAreaPerHectare))^b3*DBH))^(b4 + b4p * isPlantation), umca2016physio, start = list(a1 = 13, a4 = -0.01, b1 = 0.08, b2 = -0.05, b3 = 0.0, b4 = 1.2, b4p = -0.23), folds = 1, repetitions = 1)
  umcaHeightFromDiameterPreferred$sharmaZhang = fit_gsl_nls("Sharma-Zhang", TotalHt ~ 1.37 + a1*standBasalAreaPerHectare^b1*(1 - exp(b2*tph^b3*DBH))^(b4 + b4p * isPlantation), umca2016, start = list(a1 = 13, b1 = 0.1, b2 = -0.06, b3 = 0.125, b4 = 1.1, b4p = -0.2), folds = 1, repetitions = 1)
  umcaHeightFromDiameterPreferred$sibbesen = fit_gsl_nls("Sibbesen", TotalHt ~ 1.37 + (a1 + a1p * isPlantation)*DBH^(b1*DBH^(b2 + b2p * isPlantation)), umca2016, start = list(a1 = 0.30, a1p = 0.13, b1 = 1.96, b2 = -0.165, b2p = -0.034), folds = 1, repetitions = 1)
  #AIC(umcaHeightFromDiameterPreferred$prodan, umcaHeightFromDiameterPreferred$sibbesen)
  
  umcaDiameterFromHeightPreferred = list(gam = fit_gam("REML GAM", DBH ~ s(TotalHt, bs = "ts", by = as.factor(isPlantation), k = 9, pc = gamConstraint), data = umca2016, constraint = umca2016gamConstraint, folds = 1, repetitions = 1))
  umcaDiameterFromHeightPreferred$gamRelHtPhysio = fit_gam("REML GAM RelHt physio", DBH ~ s(TotalHt, slope, sin(3.14159/180 * aspect), relativeHeight, bs = "ts", by = as.factor(isPlantation), k = 57, pc = gamConstraint), data = umca2016physio, constraint = umca2016gamConstraint, folds = 1, repetitions = 1)
  umcaDiameterFromHeightPreferred$linear = fit_lm("linear", DBH ~ 0 + I(TotalHt - 1.37) + I(isPlantation*(TotalHt - 1.37)), umca2016, folds = 1, repetitions = 1)
  
  save(file = "trees/height-diameter/data/UMCA preferred models.Rdata", umcaHeightFromDiameterPreferred, umcaDiameterFromHeightPreferred)
}


## basal area from height
if (htDiaOptions$includeInvestigatory)
{
  umcaBasalAreaFromHeightKorf = gsl_nls(basalArea ~ a1*(exp(b1*(imputedHeight - 1.37)^(b2 + b2p*isPlantation)) - 1), umca2016, start = list(a1 = 1.36, b1 = 0.0002, b2 = 2.06, b2p = -0.27), weights = heightWeight^2) # a1p, b1p not significant, step factor with nlrob()
  umcaBasalAreaFromHeightPower = gsl_nls(basalArea ~ (a1 + a1p*isPlantation)*(imputedHeight - 1.37)^b1, umca2016, start = list(a1 = 3/7 * 0.25 * pi * 0.01^2, a1p = -0.0002, b1 = 2.00), weights = heightWeight^2) # b1p not significant
  #confint2(umcaBasalAreaFromHeightKorf, level = 0.99)

  tribble(~method, ~aic, ~biasCm2, ~maeM2, ~nse,
          "Korf", AIC(umcaBasalAreaFromHeightKorf), 100^2 * mean(residuals(umcaBasalAreaFromHeightKorf)), mean(abs(residuals(umcaBasalAreaFromHeightKorf))), 1 - sum(residuals(umcaBasalAreaFromHeightKorf)^2) / sum((umca2016$basalArea - mean(umca2016$basalArea)^2)),
          "power", AIC(umcaBasalAreaFromHeightPower), 100^2 * mean(residuals(umcaBasalAreaFromHeightPower)), mean(abs(residuals(umcaBasalAreaFromHeightPower))), 1 - sum(residuals(umcaBasalAreaFromHeightPower)^2) / sum((umca2016$basalArea - mean(umca2016$basalArea)^2))) %>%
    mutate(deltaAIC = aic - min(aic)) %>%
    arrange(desc(deltaAIC))
  
  ggplot(umca2016) +
    geom_point(aes(x = imputedHeight, y = 0.25*pi*(0.01*DBH)^2), alpha = 0.1, color = "grey25", shape = 16) +
    geom_line(aes(x = imputedHeight, y = predict(umcaBasalAreaFromHeightKorf), color = "Korf", group = isPlantation)) +
    geom_line(aes(x = imputedHeight, y = predict(umcaBasalAreaFromHeightPower), color = "power", group = isPlantation)) +
    #geom_path(aes(x = imputedHeight, y = 10*(1 - exp(-0.1*(imputedHeight - 1.37)))^1.2, color = "Chapman-Richards")) +
    labs(x = "Oregon myrtle height, m", y = "basal area, m²", color = NULL) +
    theme(legend.justification = c(0, 1), legend.position = c(0.03, 0.99))
}